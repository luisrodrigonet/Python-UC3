# 15.01 - CRUD - Produtos

## Instalar django-crispy-forms + crispy-bootstrap5

```bash
pip install django-crispy-forms crispy-bootstrap5
```


## Configurar settings.py

```python
# config/settings.py
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    # Aula 15
    'crispy_forms',           
    'crispy_bootstrap5', 
    ...
]

# Aula 15 - Crispy Forms
CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap5"
CRISPY_TEMPLATE_PACK = "bootstrap5"
```


## Views CRUD Produtos (produtos/views.py)

O comando `from django.contrib.auth.mixins import LoginRequiredMixin, UserPassesTestMixin` importa dois "**mixins**" da biblioteca oficial do Django, usados para controlar o acesso de usuários a determinadas páginas ou ações da sua aplicação web.

**`LoginRequiredMixin`** - é utilizado para garantir que **apenas usuários autenticados** possam acessar determinadas views (páginas ou funcionalidades). Quando um usuário tenta acessar uma view que contém esse mixin sem estar logado, ele é **automaticamente redirecionado para a página de login**. Isso é especialmente útil para proteger áreas restritas do site, como painéis de administração, áreas de membros, ou funcionalidades sensíveis.

**`UserPassesTestMixin`** - permite **adicionar restrições ainda mais específicas** sobre quem pode acessar determinada view. Com ele, você define uma **função** chamada **test_func()** dentro da sua view, e apenas os usuários que passarem nesse teste terão acesso. Por exemplo, você pode limitar o acesso a usuários que pertencem a um grupo específico, têm um determinado e-mail ou qualquer outra condição personalizada.


```python
##
# Imports 
##
from django.shortcuts import render

from django.views.generic import (
    ListView,
    DetailView,
    CreateView,
    UpdateView,
    DeleteView,
)
from django.contrib.auth.mixins import (
    LoginRequiredMixin,
    UserPassesTestMixin,
)

from django.urls import reverse_lazy

from .models import (
    Categoria,
    Produto,
    Cliente,
)


##
# Produtos - Create 
##
class ProdutoCreateView(LoginRequiredMixin, UserPassesTestMixin, CreateView):
    model = Produto
    fields = ['nome', 'descricao', 'preco', 'estoque', 'categoria', 'foto']
    template_name = 'produtos/produtos/produto_form.html'
    success_url = reverse_lazy('produtos:produto_list')
    
    def test_func(self):
        return self.request.user.is_staff
    
    def form_valid(self, form):
        form.instance.criado_por = self.request.user
        return super().form_valid(form)

##
# Produtos - Update 
##
class ProdutoUpdateView(LoginRequiredMixin, UserPassesTestMixin, UpdateView):
    model = Produto
    fields = ['nome', 'descricao', 'preco', 'estoque', 'categoria', 'foto']
    template_name = 'produtos/produtos/produto_form.html'
    success_url = reverse_lazy('produtos:produto_list')
    
    def test_func(self):
        return self.request.user.is_staff

##
# Produtos - Delete 
##
class ProdutoDeleteView(LoginRequiredMixin, UserPassesTestMixin, DeleteView):
    model = Produto
    template_name = 'produtos/produtos/produto_confirm_delete.html'
    success_url = reverse_lazy('produtos:produto_list')
    
    def test_func(self):
        return self.request.user.is_staff
```

## URLs Atualizadas (produtos/urls.py)

```python
from django.urls import path
from . import views

app_name = 'produtos'

urlpatterns = [
    # PRODUTOS - CRUD COMPLETO
    path(
        "",
        views.ProdutoListView.as_view(),
        name="produto_list",
    ),
    path(
        "produtos/",
        views.ProdutoListView.as_view(),
        name="produto_list",
    ),
    path(
        "produtos/<int:pk>/",
        views.ProdutoDetailView.as_view(),
        name="produto_detail",
    ),
    path(
        "produtos/novo/",
        views.ProdutoCreateView.as_view(),
        name="produto_create",
    ),
    path(
        "produtos/<int:pk>/editar/",
        views.ProdutoUpdateView.as_view(),
        name="produto_update",
    ),
    path(
        "produtos/<int:pk>/excluir/",
        views.ProdutoDeleteView.as_view(),
        name="produto_delete",
    ),
    
    # CATEGORIAS
    path('categorias/', views.CategoriaListView.as_view(), name='categoria_list'),
    path('categorias/<int:pk>/', views.CategoriaDetailView.as_view(), name='categoria_detail'),
    
    # CLIENTES (Admin)
    path('clientes/', views.ClienteListView.as_view(), name='cliente_list'),
    path('clientes/<int:pk>/', views.ClienteDetailView.as_view(), name='cliente_detail'),
    
    # PEDIDOS (Usuário logado)
    path('pedidos/', views.PedidoListView.as_view(), name='pedido_list'),
    path('pedidos/<int:pk>/', views.PedidoDetailView.as_view(), name='pedido_detail'),
]
```


## Template `produto_form.html` 

Crie `templates/produtos/produtos/produto_form.html`:

```html
{% extends 'produtos/base.html' %}
{% load crispy_forms_tags %}

{% block title %}
    {% if form.instance.pk %}
        Editar
    {% else %}
        Novo
    {% endif %} 
        Produto - Loja Config
    {% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus-circle{% endif %} me-2"></i>
                   
                    {% if form.instance.pk %}
                        Editar
                    {% else %}
                        Novo
                    {% endif %} 
                    Produto

                </h3>
            </div>
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data">

                    {% csrf_token %}
                    
                    {{ form|crispy }}
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>
                            {% if form.instance.pk %}
                                Atualizar
                            {% else %}
                                Criar
                            {% endif %} 
                            Produto
                        </button>
                        
                        <a href="{% url 'produtos:produto_list' %}" 
                            class="btn btn-outline-secondary">
                            
                            <i class="fas fa-arrow-left me-2"></i>
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
```

## Template `produto_confirm_delete.html`

Crie `templates/produtos/produtos/produto_confirm_delete.html`:

```html
{% extends 'produtos/base.html' %}

{% block title %}Excluir Produto - Loja Config{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card border-danger shadow">
            <div class="card-header bg-danger text-white text-center">

                <h3 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Exclusão
                </h3>
            </div>
            <div class="card-body text-center p-5">
                <i class="fas fa-trash-alt fa-5x text-danger mb-4"></i>
                
                <h4 class="text-danger mb-3">Tem certeza que deseja excluir este produto?</h4>
                
                <div class="alert alert-warning">
                    <strong>Produto:</strong> <span class="fw-bold">{{ object.nome }}</span><br>
                    <strong>Preço:</strong> R$ {{ object.preco|floatformat:2 }}<br>
                    <strong>Estoque:</strong> {{ object.estoque }} unidades
                </div>
                
                <form method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-lg me-3">
                        <i class="fas fa-trash me-2"></i>Sim, Excluir
                    </button>
                </form>
                <a href="{% url 'produtos:produto_list' %}" 
                    class="btn btn-outline-secondary btn-lg">
                    
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
```

## Atualizar `produto_list.html` (Botões CRUD)


```html
{% extends 'produtos/base.html' %}

{% block title %}Produtos - Loja Config{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3 mb-0">
        <i class="fas fa-box-open me-2 text-primary"></i>Produtos Disponíveis
    </h2>
    
    <!-- Botão Novo Produto (ADMIN) -->
    {% if user.is_authenticated and user.is_staff %}
    <div>
        <a href="{% url 'produtos:produto_create' %}" class="btn btn-success btn-lg">
            <i class="fas fa-plus me-2"></i>Novo Produto
        </a>
    </div>
    {% endif %}
    
    <span class="badge bg-success fs-5">
        {{ produtos|length }} produto{{ produtos|length|pluralize }}
    </span>
</div>

<!-- Tabela com CRUD COMPLETO -->
<div class="card shadow-lg">
    <div class="card-header bg-light border-bottom">
        <strong>Gerencie os Produtos do Sistema</strong>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-dark">
                    <tr>
                        <th width="60">#</th>
                        <th width="80">Foto</th>
                        <th>Nome</th>
                        <th>Descrição</th>
                        <th width="120">Preço</th>
                        <th width="100">Estoque</th>
                        <th width="120">Categoria</th>
                        <th width="220">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produto in produtos %}
                    <tr>
                        <th scope="row" class="fw-bold">{{ forloop.counter }}</th>
                        <td>
                            {% if produto.foto %}
                                <img src="{{ produto.foto.url }}" 
                                     alt="{{ produto.nome }}" 
                                     class="rounded shadow-sm" 
                                     style="width: 60px; height: 60px; object-fit: cover;"
                                     loading="lazy">
                            {% else %}
                                <div class="bg-light border rounded d-flex align-items-center justify-content-center shadow-sm" 
                                     style="width: 60px; height: 60px; font-size: 1.2rem;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <strong class="d-block text-dark">{{ produto.nome }}</strong>
                                <small class="text-muted">ID: {{ produto.id }}</small>
                            </div>
                        </td>
                        <td>
                            <span class="text-truncate d-block" style="max-width: 200px;" 
                                  title="{{ produto.descricao }}">
                                {{ produto.descricao|truncatewords:10 }}
                            </span>
                        </td>
                        <td>
                            <span class="h6 fw-bold text-success">
                                R$ {{ produto.preco|floatformat:2 }}
                            </span>
                        </td>
                        <td>
                            <span class="badge fs-6 px-3 py-2 
                                {% if produto.estoque > 10 %}bg-success
                                {% elif produto.estoque > 0 %}bg-warning
                                {% else %}bg-danger{% endif %}">
                                {{ produto.estoque }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-primary fs-6 px-3">{{ produto.categoria.nome }}</span>
                        </td>
                        <td>
                            <!-- BOTÕES DE AÇÃO SEMPRE VISÍVEIS PARA ADMIN -->
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <!-- VER (todos) -->
                                <a href="{% url 'produtos:produto_detail' produto.pk %}" 
                                   class="btn btn-outline-primary" 
                                   title="Ver detalhes">
                                    <i class="fas fa-eye"></i>
                                </a>
                                
                                <!-- CRUD (apenas admin logado) -->
                                {% if user.is_authenticated and user.is_staff %}
                                <a href="{% url 'produtos:produto_update' produto.pk %}" 
                                   class="btn btn-outline-warning" 
                                   title="Editar produto">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'produtos:produto_delete' produto.pk %}" 
                                   class="btn btn-outline-danger" 
                                   title="Excluir produto"
                                   onclick="return confirm('Tem certeza que deseja excluir {{ produto.nome }}?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                                {% else %}
                                <!-- Placeholder para não-admin -->
                                <span class="btn btn-outline-secondary disabled" title="Login admin necessário">
                                    <i class="fas fa-lock"></i>
                                </span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-boxes-empty fa-4x mb-4 opacity-50"></i>
                                <h3 class="mb-4">Nenhum produto encontrado</h3>
                                {% if user.is_authenticated and user.is_staff %}
                                <a href="{% url 'produtos:produto_create' %}" 
                                   class="btn btn-primary btn-lg px-4">
                                    <i class="fas fa-plus-circle me-2"></i>
                                    Criar Primeiro Produto
                                </a>
                                {% else %}
                                <p class="lead">Faça login como administrador para gerenciar produtos.</p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Navegação Rápida -->
<div class="mt-4 d-flex gap-2 justify-content-center flex-wrap">
    <a href="{% url 'produtos:categoria_list' %}" class="btn btn-outline-primary">
        <i class="fas fa-tags me-2"></i>Categorias
    </a>
    {% if user.is_authenticated %}
    <a href="{#% url 'produtos:pedido_list' %#}" class="btn btn-outline-success">
        <i class="fas fa-shopping-bag me-2"></i>Meus Pedidos
    </a>
    {% endif %}
    {% if user.is_authenticated and user.is_staff %}
    <a href="{% url 'produtos:cliente_list' %}" class="btn btn-outline-info">
        <i class="fas fa-users me-2"></i>Clientes (Admin)
    </a>
    {% endif %}
</div>
{% endblock %}

```

