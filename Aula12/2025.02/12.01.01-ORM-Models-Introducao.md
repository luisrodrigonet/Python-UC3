# Django ORM: Mapeamento Objeto-Relacional Completo

O Django ORM (`Object-Relational Mapper`) √© uma das ferramentas mais poderosas do framework Django. Ele permite que voc√™ **interaja com o banco de dados usando c√≥digo Python** orientado a objetos, **sem necessidade de escrever SQL diretamente**. O ORM traduz suas **classes Python em tabelas de banco de dados** e suas opera√ß√µes em Python para queries SQL.

Para contextualizar os conceitos que vamos aprender, vamos desenvolver uma aplica√ß√£o de **gest√£o de biblioteca**, que inclui modelos para livros, autores, editoras, empr√©stimos e usu√°rios.

## ü§ñ Tipos de Campos no Django ORM

O Django oferece uma **vasta gama de tipos de campos** para representar diferentes tipos de dados. Vamos explorar cada um deles em detalhes, sempre pensando em como aplic√°-los em nossa biblioteca.

### 1. Propriedades Comuns  para todos os campos

Antes de explorar as propriedades espec√≠ficas, √© importante relembrar que **todos os campos** suportam as seguintes propriedades:

- `null` - Permite valores NULL no banco de dados
- `blank` - Permite valores vazios em formul√°rios
- `choices` - Define op√ß√µes fixas para o campo
- `default` - Valor padr√£o
- `db_column` - Nome da coluna no banco
- `db_comment` - Coment√°rio na coluna do banco
- `db_default` - Valor padr√£o calculado pelo banco
- `db_index` - Cria √≠ndice no banco
- `db_tablespace` - Define tablespace para √≠ndices
- `editable` - Controla se aparece em formul√°rios
- `error_messages` - Mensagens de erro personalizadas
- `help_text` - Texto de ajuda
- `primary_key` - Define como chave prim√°ria
- `unique` - Garante unicidade
- `unique_for_date` - √önico para a data especificada
- `unique_for_month` - √önico para o m√™s especificado
- `unique_for_year` - √önico para o ano especificado
- `verbose_name` - Nome leg√≠vel
- `validators` - Lista de validadores


### 2. Campos Num√©ricos

#### 2.1. **IntegerField**

N√∫mero inteiro padr√£o. Armazena n√∫meros inteiros entre **-2147483648** e **2147483647**.

**Propriedades Espec√≠ficas:** Nenhuma al√©m das comuns.

```python
class Livro(models.Model):
    quantidade_paginas = models.IntegerField()
    exemplares_disponiveis = models.IntegerField(default=0)
```

```python
class Livro(models.Model):
    quantidade_paginas = models.IntegerField(
        validators=[
            MinValueValidator(1),
            MaxValueValidator(10000)
        ]
    )
    ano_publicacao = models.IntegerField()
```

üßµ **Propriedades principais:**
- `default`: valor padr√£o quando n√£o especificado
- `validators`: lista de validadores customizados
- `null`: permite valores NULL no banco (padr√£o: False)
- `blank`: permite campo vazio em formul√°rios (padr√£o: False)
- Validadores MinValueValidator e MaxValueValidator aplicados automaticamente

#### 2.2 **BigIntegerField**

Para n√∫meros muito grandes (64 bits), √∫til para grandes contagens.

```python
class Estatisticas(models.Model):
    total_visualizacoes = models.BigIntegerField(default=0)
```

```python
class Estatisticas(models.Model):
    total_visualizacoes = models.BigIntegerField(default=0)
    total_downloads = models.BigIntegerField(default=0)
```

**Caracter√≠sticas:**
- Valores de -9223372036854775808 a 9223372036854775807

#### 2.3 **SmallIntegerField**

Para n√∫meros pequenos (-32768 a 32767), economiza espa√ßo no banco.

```python
class Avaliacao(models.Model):
    nota = models.SmallIntegerField(
        validators=[MinValueValidator(1), MaxValueValidator(5)]
    )
```

#### 2.4 **PositiveIntegerField**

Aceita apenas valores positivos (0 a 2147483647). Aceita zero por compatibilidade retroativa.

```python
class Livro(models.Model):
    ano_publicacao = models.PositiveIntegerField()
    edicao = models.PositiveIntegerField(default=1)
```

#### 2.5 **PositiveBigIntegerField**

Inteiro positivo de 64 bits.

**Propriedades Espec√≠ficas:** Nenhuma al√©m das comuns.

```python
class Contador(models.Model):
    total = models.PositiveBigIntegerField(default=0)
```

**Caracter√≠sticas:**
- Valores de 0 a 9223372036854775807

#### 2.6. **PositiveSmallIntegerField**

Inteiro pequeno positivo.

**Propriedades Espec√≠ficas:** Nenhuma al√©m das comuns.

```python
class Livro(models.Model):
    edicao = models.PositiveSmallIntegerField(default=1)
```

**Caracter√≠sticas:**
- Valores de 0 a 32767


#### 2.7. **FloatField**
N√∫meros de ponto flutuante, √∫til para valores decimais aproximados.

```python
class Livro(models.Model):
    peso_kg = models.FloatField(
        help_text="Peso do livro em quilogramas"
    )
    altura_cm = models.FloatField()
```

**Caracter√≠sticas:**
- Usa o tipo `float` do Python
- Precis√£o aproximada (n√£o recomendado para valores monet√°rios)

#### 2.8. **DecimalField**

Para valores decimais de precis√£o fixa, ideal para valores monet√°rios.

```python
class Livro(models.Model):
    preco = models.DecimalField(
        max_digits=8,      # Total de d√≠gitos (incluindo decimais)
        decimal_places=2,  # N√∫mero de casas decimais
        validators=[MinValueValidator(0)],
        help_text="Pre√ßo em reais"
    )

    desconto_percentual = models.DecimalField(
        max_digits=5,
        decimal_places=2,    # Ex: 100.00
        default=0
    )
```

**Propriedades obrigat√≥rias:**
- `max_digits`: n√∫mero m√°ximo de d√≠gitos
- `decimal_places`: casas decimais

**Caracter√≠sticas:**
- Usa o tipo `Decimal` do Python
- Precis√£o exata (ideal para valores monet√°rios)
- `max_digits` deve ser maior ou igual a `decimal_places`

#### 2.9 **AutoField**

Campo inteiro que incrementa automaticamente.

**Propriedades Espec√≠ficas:** Nenhuma al√©m das comuns.

```python
class Livro(models.Model):
    # Django cria automaticamente se n√£o houver primary_key definida
    # id = models.AutoField(primary_key=True)
    titulo = models.CharField(max_length=200)
```

**Caracter√≠sticas:**
- Incrementa de 1 a 9223372036854775807
- Adicionado automaticamente se nenhuma chave prim√°ria for definida
- N√£o precisa ser declarado explicitamente

#### 2.10 **BigAutoField**

AutoField de 64 bits para grandes volumes de dados.

**Propriedades Espec√≠ficas:** Nenhuma al√©m das comuns.

```python
class HistoricoAcessos(models.Model):
    id = models.BigAutoField(primary_key=True)
    data_acesso = models.DateTimeField(auto_now_add=True)
```

**Caracter√≠sticas:**
- Valores de 1 a 9223372036854775807
- Ideal para tabelas com muitos registros

#### 2.11 **SmallAutoField**

AutoField menor para economizar espa√ßo.

**Propriedades Espec√≠ficas:** Nenhuma al√©m das comuns.

```python
class Categoria(models.Model):
    id = models.SmallAutoField(primary_key=True)
    nome = models.CharField(max_length=100)
```

**Caracter√≠sticas:**
- Valores de 1 a 32767
- √ötil para tabelas pequenas




### 3. Campos de Texto

#### 3.1. **CharField**
Para textos curtos a m√©dios.

```python
class Autor(models.Model):
    nome = models.CharField(
        max_length=200,
        unique=True,
        help_text="Nome completo do autor"
    )
    
    nacionalidade = models.CharField(
        max_length=100,
        blank=True,
        default=""
    )
```

```python
class Autor(models.Model):
    nome = models.CharField(
        max_length=200,
        unique=True,
        db_index=True
    )
    
    cpf = models.CharField(
        max_length=11,
        unique=True,
        validators=[
            RegexValidator(r'^\d{11}$', 'CPF deve ter 11 d√≠gitos')
        ]
    )
    
    # Com collation espec√≠fica
    nome_ordenacao = models.CharField(
        max_length=200,
        db_collation='utf8mb4_unicode_ci'  # MySQL/MariaDB
    )
```

**Propriedades importantes:**
- `max_length`: tamanho m√°ximo (obrigat√≥rio, exceto em PostgreSQL e SQLite)
- `unique`: garante unicidade
- `blank`: permite campo vazio em formul√°rios
- `db_collation`: define collation do banco
- No PostgreSQL e SQLite (5.2+), pode ser ilimitado se `max_length` n√£o for especificado
- Armazenado como VARCHAR no banco

#### 3.2. **TextField**
Para textos longos sem limite de tamanho.

```python
class Livro(models.Model):
    sinopse = models.TextField(
        blank=True,
        help_text="Descri√ß√£o completa do livro"
    )
    
    observacoes = models.TextField(
        default="",
        blank=True
    )
```

```python
class Livro(models.Model):
    sinopse = models.TextField(
        blank=True,
        help_text="Descri√ß√£o completa do livro"
    )
    
    notas = models.TextField(
        default="",
        blank=True
    )
    
    # Com collation (n√£o suportado no Oracle)
    conteudo = models.TextField(
        db_collation='utf8mb4_general_ci'
    )
```

**Propriedades Espec√≠ficas:**
- **`db_collation`** - Collation do banco de dados

**Caracter√≠sticas:**
- Sem limite de tamanho
- Widget padr√£o: `Textarea`
- `max_length` pode ser especificado para valida√ß√£o em formul√°rios, mas n√£o no banco
- Oracle n√£o suporta collation

#### 3.3 **SlugField**
Campo otimizado para URLs (aceita letras, n√∫meros, underscores e h√≠fens).

```python
class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    slug = models.SlugField(
        max_length=250,
        unique=True,
        allow_unicode=True  # Permite caracteres Unicode
    )
```

```python
class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    
    slug = models.SlugField(
        max_length=250,
        unique=True,
        allow_unicode=True,  # Permite acentos e outros caracteres Unicode
        db_index=True
    )
    
    # Slug apenas ASCII
    slug_simples = models.SlugField(
        max_length=200,
        allow_unicode=False  # Apenas letras, n√∫meros, underscore e h√≠fen
    )
```

**Propriedades Espec√≠ficas:**
- **`max_length`** - Tamanho m√°ximo (padr√£o: 50)
- **`allow_unicode`** - Permite caracteres Unicode (padr√£o: False)

**Caracter√≠sticas:**
- Implica `db_index=True` automaticamente
- Valida com `validate_slug` ou `validate_unicode_slug`
- Ideal para URLs amig√°veis



#### 3.4 **EmailField**
Valida endere√ßos de e-mail automaticamente.

**Propriedades Espec√≠ficas:**
- **`max_length`** - Tamanho m√°ximo (padr√£o: 254)


```python
class Usuario(models.Model):
    email = models.EmailField(
        unique=True,
        error_messages={
            'unique': 'Este e-mail j√° est√° cadastrado.',
        }
    )
```


```python
class Usuario(models.Model):
    email = models.EmailField(
        unique=True,
        error_messages={
            'unique': 'Este e-mail j√° est√° cadastrado.',
            'invalid': 'Digite um e-mail v√°lido.'
        }
    )
    
    email_alternativo = models.EmailField(
        max_length=254,
        blank=True,
        default=""
    )
```

**Caracter√≠sticas:**
- Valida√ß√£o autom√°tica com `EmailValidator`
- Padr√£o de 254 caracteres (RFC 3696/5321)

#### 3.5 **URLField**
Valida URLs automaticamente.

**Propriedades Espec√≠ficas:**
- **`max_length`** - Tamanho m√°ximo (padr√£o: 200)

```python
class Autor(models.Model):
    website = models.URLField(
        blank=True,
        help_text="Site pessoal do autor"
    )
```

```python
class Autor(models.Model):
    website = models.URLField(
        blank=True,
        help_text="Site pessoal do autor"
    )
    
    linkedin = models.URLField(
        max_length=300,
        blank=True
    )
```

**Caracter√≠sticas:**
- Valida√ß√£o autom√°tica com `URLValidator`
- Aceita URLs completas (http:// ou https://)


### 4. Campos de Data e Hora

#### 4.1. **DateField**

Armazena apenas datas.

```python
class Autor(models.Model):
    data_nascimento = models.DateField(
        null=True,
        blank=True
    )

class Livro(models.Model):
    data_publicacao = models.DateField(
        help_text="Data de primeira publica√ß√£o"
    )
```

```python
class Livro(models.Model):
    data_publicacao = models.DateField(
        help_text="Data de primeira publica√ß√£o"
    )
    
    data_cadastro = models.DateField(
        auto_now_add=True  # Definido apenas na cria√ß√£o
    )
    
    data_atualizacao = models.DateField(
        auto_now=True  # Atualizado a cada save()
    )
```

**Caracter√≠sticas:**
- Representado por `datetime.date` do Python
- `auto_now` e `auto_now_add` implica `editable=False` e `blank=True`
- `auto_now`, `auto_now_add` e `default` s√£o mutuamente exclusivos
- Widget padr√£o: DateInput com calend√°rio no admin
- Inclui chave de erro adicional: `invalid_date`
- `auto_now`: atualiza automaticamente a cada save()
- `auto_now_add`: define a data apenas na cria√ß√£o

```python
class Emprestimo(models.Model):
    data_criacao = models.DateField(auto_now_add=True)
    data_atualizacao = models.DateField(auto_now=True)
```

#### 4.2 **DateTimeField**
Armazena data e hora completas.

**Propriedades Espec√≠ficas:**
- **`auto_now`** - Atualiza automaticamente a cada save()
- **`auto_now_add`** - Define apenas na cria√ß√£o

```python
class Emprestimo(models.Model):
    data_emprestimo = models.DateTimeField(auto_now_add=True)
    data_devolucao_prevista = models.DateTimeField()
    data_devolucao_efetiva = models.DateTimeField(
        null=True,
        blank=True
    )
```

```python
class Emprestimo(models.Model):
    data_emprestimo = models.DateTimeField(
        auto_now_add=True
    )
    
    data_devolucao_prevista = models.DateTimeField()
    
    data_devolucao_efetiva = models.DateTimeField(
        null=True,
        blank=True
    )
    
    ultima_atualizacao = models.DateTimeField(
        auto_now=True
    )
```

**Caracter√≠sticas:**
- Representado por `datetime.datetime` do Python
- Mesmas regras de `auto_now` e `auto_now_add` do DateField
- Widget padr√£o: DateTimeInput (dois widgets separados no admin)

#### 4.3. **TimeField**
Armazena apenas hor√°rios.

**Propriedades Espec√≠ficas:**
- **`auto_now`** - Atualiza automaticamente
- **`auto_now_add`** - Define apenas na cria√ß√£o

```python
class Biblioteca(models.Model):
    horario_abertura = models.TimeField()
    horario_fechamento = models.TimeField()
```

```python
class Biblioteca(models.Model):
    horario_abertura = models.TimeField()
    horario_fechamento = models.TimeField()
    
    ultimo_acesso = models.TimeField(
        auto_now=True
    )
```

**Caracter√≠sticas:**
- Representado por `datetime.time` do Python
- Aceita as mesmas op√ß√µes de auto-popula√ß√£o do DateField


#### 4.4 **DurationField**

Armazena per√≠odos de tempo.

```python
class ConfiguracaoEmprestimo(models.Model):
    prazo_padrao = models.DurationField(
        default=timedelta(days=14),
        help_text="Prazo padr√£o para empr√©stimos"
    )
```

```python
from datetime import timedelta

class ConfiguracaoEmprestimo(models.Model):
    prazo_padrao = models.DurationField(
        default=timedelta(days=14),
        help_text="Prazo padr√£o para empr√©stimos"
    )
    
    prazo_renovacao = models.DurationField(
        default=timedelta(days=7)
    )
```

**Caracter√≠sticas:**
- Representado por `timedelta` do Python
- PostgreSQL: tipo `interval`
- Oracle: tipo `INTERVAL DAY(9) TO SECOND(6)`
- Outros bancos: `bigint` de microsegundos
- Aritm√©tica com `DateTimeField` funciona melhor no PostgreSQL

### 5. Campos Booleanos

#### 5.1. **BooleanField**

Armazena valores True/False.


```python
class Livro(models.Model):
    disponivel = models.BooleanField(default=True)
    destaque = models.BooleanField(default=False)
```

```python
class Livro(models.Model):
    disponivel = models.BooleanField(
        default=True
    )
    
    destaque = models.BooleanField(
        default=False
    )
    
    publicado = models.BooleanField(
        default=False,
        help_text="Se o livro est√° dispon√≠vel para venda"
    )
```

**Caracter√≠sticas:**
- Widget padr√£o: CheckboxInput (ou NullBooleanSelect se `null=True`)
- Valor padr√£o √© `None` quando `Field.default` n√£o est√° definido
- Aceita True/False

### 6. Campos de Arquivo

#### 6.1. **FileField**

Para upload de arquivos gen√©ricos.

```python
class Livro(models.Model):
    arquivo_pdf = models.FileField(
        upload_to='livros/pdfs/%Y/%m/',
        blank=True,
        null=True
    )
```

**Propriedades Espec√≠ficas:**
- **`upload_to`** - Diret√≥rio ou fun√ß√£o para definir caminho de upload
- **`storage`** - Objeto de storage customizado
- **`max_length`** - Tamanho do campo VARCHAR (padr√£o: 100)

```python
class Livro(models.Model):
    # Upload para diret√≥rio fixo
    arquivo_pdf = models.FileField(
        upload_to='livros/pdfs/',
        blank=True,
        null=True,
        max_length=200
    )
    
    # Upload com data no caminho
    contrato = models.FileField(
        upload_to='contratos/%Y/%m/%d/'  # Ex: contratos/2023/11/24/
    )
    
    # Upload com fun√ß√£o customizada
    def livro_upload_path(instance, filename):
        return f'livros/{instance.id}/{filename}'
    
    documento = models.FileField(
        upload_to=livro_upload_path
    )
```

**Caracter√≠sticas:**
- Requer configura√ß√£o de `MEDIA_ROOT` e `MEDIA_URL`
- `upload_to` pode ser string ou callable
- Callable recebe `(instance, filename)` como argumentos
- Acesso ao arquivo via `objeto.campo.url`
- M√©todos dispon√≠veis: `.name`, `.path`, `.size`, `.url`, `.open()`, `.close()`, `.save()`, `.delete()`

#### 6.2. **ImageField**
Para upload de imagens, valida que o arquivo √© uma imagem v√°lida.

**Propriedades Espec√≠ficas:**
- **`upload_to`** - Diret√≥rio ou fun√ß√£o para upload
- **`storage`** - Objeto de storage
- **`max_length`** - Tamanho do VARCHAR (padr√£o: 100)
- **`height_field`** - Campo para armazenar altura da imagem
- **`width_field`** - Campo para armazenar largura da imagem

```python
class Livro(models.Model):
    capa = models.ImageField(
        upload_to='livros/capas/',
        height_field='altura_capa',
        width_field='largura_capa',
        blank=True
    )
    altura_capa = models.PositiveIntegerField(null=True, blank=True)
    largura_capa = models.PositiveIntegerField(null=True, blank=True)
```

```python
class Livro(models.Model):
    # ImageField b√°sico
    capa = models.ImageField(
        upload_to='livros/capas/',
        blank=True
    )
    
    # Com campos de dimens√µes
    capa_completa = models.ImageField(
        upload_to='livros/capas/%Y/',
        height_field='altura_capa',  # Nome do campo IntegerField
        width_field='largura_capa',  # Nome do campo IntegerField
        blank=True
    )
    altura_capa = models.PositiveIntegerField(
        null=True,
        blank=True,
        editable=False
    )
    largura_capa = models.PositiveIntegerField(
        null=True,
        blank=True,
        editable=False
    )
```

**Caracter√≠sticas:**
- Herda todas as propriedades de `FileField`
- Valida que o arquivo √© uma imagem v√°lida
- Requer biblioteca Pillow
- `height_field` e `width_field` s√£o auto-populados ao salvar[5][6][7][4]
- Armazenado como VARCHAR no banco
- Atributos adicionais: `.height` e `.width`

#### 6.3. **FilePathField**

Campo com choices limitadas a arquivos de um diret√≥rio.

**Propriedades Espec√≠ficas:**
- **`path`** - Caminho absoluto do diret√≥rio (obrigat√≥rio)
- **`match`** - Regex para filtrar nomes de arquivo
- **`recursive`** - Incluir subdiret√≥rios (padr√£o: False)
- **`allow_files`** - Incluir arquivos (padr√£o: True)
- **`allow_folders`** - Incluir pastas (padr√£o: False)
- **`max_length`** - Tamanho do VARCHAR (padr√£o: 100)

```python
import os
from django.conf import settings

class Documento(models.Model):
    # Path fixo
    template = models.FilePathField(
        path="/home/templates/",
        match=".*\.html$",  # Apenas arquivos .html
        recursive=False
    )
    
    # Path din√¢mico com fun√ß√£o
    def get_images_path():
        return os.path.join(settings.BASE_DIR, 'images')
    
    imagem = models.FilePathField(
        path=get_images_path,
        match="foo.*\.png$",
        recursive=True,
        allow_files=True,
        allow_folders=False
    )
```

**Caracter√≠sticas:**
- `path` pode ser string ou callable
- `match` aplica-se apenas ao nome base do arquivo, n√£o ao caminho completo
- Pelo menos um de `allow_files` ou `allow_folders` deve ser True


### 7. Outros Campos Importantes

#### 7.1. **BinaryField**

Campo para dados bin√°rios brutos.

**Propriedades Espec√≠ficas:**
- **`max_length`** - Tamanho m√°ximo em bytes

```python
class Documento(models.Model):
    arquivo_criptografado = models.BinaryField(
        max_length=1024000,  # 1MB
        editable=False
    )
```

**Caracter√≠sticas:**
- Aceita `bytes`, `bytearray` ou `memoryview`
- `editable=False` por padr√£o
- N√£o pode ser inclu√≠do em `ModelForm`
- Valida√ß√£o de tamanho com `MaxLengthValidator`
- **Aten√ß√£o**: N√£o √© recomendado para armazenar arquivos grandes

#### 7.2. **UUIDField**
Armazena identificadores √∫nicos universais.

```python
import uuid

class Emprestimo(models.Model):
    codigo = models.UUIDField(
        default=uuid.uuid4,
        editable=False,
        unique=True
    )
```


```python
import uuid

class Emprestimo(models.Model):
    # UUID como chave prim√°ria
    id = models.UUIDField(
        primary_key=True,
        default=uuid.uuid4,  # Callable sem par√™nteses
        editable=False
    )
    
    # UUID como c√≥digo √∫nico
    codigo = models.UUIDField(
        default=uuid.uuid4,
        unique=True,
        editable=False
    )
```

**Caracter√≠sticas:**
- Usa a classe `UUID` do Python
- PostgreSQL e MariaDB 10.7+: tipo `uuid`
- Outros bancos: `char(32)`
- **Importante**: Passar callable sem par√™nteses (`uuid.uuid4` n√£o `uuid.uuid4()`)
- Lookups `icontains`, `startswith`, etc. n√£o funcionam em PostgreSQL/MariaDB com valores sem h√≠fens


#### 7.3. **JSONField**

Armazena dados JSON estruturados.

**Propriedades Espec√≠ficas:**
- **`encoder`** - Classe encoder JSON customizada
- **`decoder`** - Classe decoder JSON customizada

```python
class Livro(models.Model):
    metadados = models.JSONField(
        default=dict,
        blank=True,
        help_text="Informa√ß√µes adicionais em formato JSON"
    )
```

```python
from django.core.serializers.json import DjangoJSONEncoder

class Livro(models.Model):
    # JSONField b√°sico
    metadados = models.JSONField(
        default=dict,  # Callable, n√£o {}
        blank=True
    )
    
    # Com encoder customizado
    configuracoes = models.JSONField(
        encoder=DjangoJSONEncoder,
        decoder=None,
        default=dict
    )
```

**Caracter√≠sticas:**
- Representado por dict, list, str, int, float, bool ou None em Python
- PostgreSQL: tipo `jsonb` (n√£o `json`)
- Oracle: n√£o suporta valores escalares, apenas objetos e arrays
- **Importante**: Usar callable para default (`default=dict` n√£o `default={}`)
- `db_index` e `unique` criam B-tree index (n√£o ideal)
- PostgreSQL: use `GinIndex` para melhor performance


#### 7.4. **GenericIPAddressField**

Armazena endere√ßos IP (IPv4 ou IPv6).

Campo para endere√ßos IP.

**Propriedades Espec√≠ficas:**
- **`protocol`** - Tipo de protocolo: 'both', 'IPv4' ou 'IPv6' (padr√£o: 'both')
- **`unpack_ipv4`** - Descompacta endere√ßos IPv4 mapeados (padr√£o: False)

```python
class LogAcesso(models.Model):
    ip_usuario = models.GenericIPAddressField(
        protocol='both'  # 'both', 'IPv4' ou 'IPv6'
    )
```

```python
class LogAcesso(models.Model):
    # Aceita IPv4 e IPv6
    ip_usuario = models.GenericIPAddressField(
        protocol='both'
    )
    
    # Apenas IPv4
    ip_servidor = models.GenericIPAddressField(
        protocol='IPv4'
    )
    
    # Com unpack de IPv4
    ip_mapeado = models.GenericIPAddressField(
        protocol='both',
        unpack_ipv4=True  # ::ffff:192.0.2.1 vira 192.0.2.1
    )
```


**Caracter√≠sticas:**
- Normaliza√ß√£o de IPv6 conforme RFC 4291
- `unpack_ipv4` requer `protocol='both'`
- Se `blank=True`, deve ter `null=True` (valores em branco s√£o NULL)

#### 7.5. **GeneratedField**

Campo calculado pelo banco de dados (Django 5.0+).

**Propriedades Espec√≠ficas:**
- **`expression`** - Express√£o de banco de dados (obrigat√≥rio)
- **`output_field`** - Tipo do campo resultante (obrigat√≥rio)
- **`db_persist`** - Se ocupa espa√ßo f√≠sico (padr√£o depende do banco)

```python
from django.db.models import F, Value
from django.db.models.functions import Lower, Upper, Concat

class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    preco = models.DecimalField(max_digits=8, decimal_places=2)
    desconto = models.DecimalField(max_digits=5, decimal_places=2)
    
    # Campo calculado: pre√ßo com desconto
    preco_final = models.GeneratedField(
        expression=F('preco') * (1 - F('desconto') / 100),
        output_field=models.DecimalField(max_digits=8, decimal_places=2),
        db_persist=True  # PostgreSQL requer True
    )
    
    # Concatena√ß√£o de strings
    titulo_upper = models.GeneratedField(
        expression=Upper('titulo'),
        output_field=models.CharField(max_length=200),
        db_persist=False  # Oracle requer False
    )
```

**Caracter√≠sticas:**
- **Stored** (db_persist=True): valor armazenado fisicamente, calculado no INSERT/UPDATE
- **Virtual** (db_persist=False): calculado na leitura, n√£o ocupa espa√ßo
- PostgreSQL: apenas stored
- Oracle: apenas virtual
- Express√µes devem ser determin√≠sticas
- N√£o pode referenciar outros GeneratedFields
- **Importante**: Objeto deve ser recarregado ap√≥s save() para obter novo valor

#### 7.6. **CompositePrimaryKey**

Chave prim√°ria composta (Django 5.2+).

**Propriedades Espec√≠ficas:**
- **`*field_names`** - Lista de nomes de campos que comp√µem a PK

```python
class Autoria(models.Model):
    livro = models.ForeignKey(Livro, on_delete=models.CASCADE)
    autor = models.ForeignKey(Autor, on_delete=models.CASCADE)
    ordem = models.PositiveIntegerField(default=1)
    
    # Chave prim√°ria composta
    pk = models.CompositePrimaryKey('livro', 'autor')
    
    class Meta:
        # Alternativa tradicional (ainda suportada)
        # unique_together = [['livro', 'autor']]
        pass
```

**Caracter√≠sticas:**
- Campo virtual, n√£o cria coluna f√≠sica
- Deve ser definido como atributo `pk` do modelo
- Substitui a necessidade de `unique_together` para PKs compostas

### 8. Campos de Relacionamento

#### 8.1. **ForeignKey**

Relacionamento muitos-para-um.

**Propriedades Espec√≠ficas:**
- **`on_delete`** - Comportamento ao deletar o objeto referenciado (obrigat√≥rio)
- **`related_name`** - Nome para acesso reverso
- **`related_query_name`** - Nome para queries reversas
- **`to_field`** - Campo referenciado (padr√£o: primary key)
- **`db_constraint`** - Criar constraint no banco (padr√£o: True)
- **`limit_choices_to`** - Limitar op√ß√µes dispon√≠veis
- **`swappable`** - Se pode ser substitu√≠do (para User)

```python
class Livro(models.Model):
    # ForeignKey completa
    editora = models.ForeignKey(
        'Editora',  # Pode ser string ou classe
        on_delete=models.PROTECT,  # Op√ß√µes: CASCADE, PROTECT, SET_NULL, etc.
        related_name='livros',  # editora.livros.all()
        related_query_name='livro',  # Editora.objects.filter(livro__ano=2023)
        to_field='codigo',  # Referencia outro campo que n√£o o PK
        db_constraint=True,  # Criar constraint FK no banco
        limit_choices_to={'ativa': True},  # Apenas editoras ativas
        db_column='editora_id',  # Nome da coluna no banco
        verbose_name='Editora do Livro'
    )
    
    # Com Q objects para limit_choices_to
    from django.db.models import Q
    
    usuario_responsavel = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        limit_choices_to=Q(is_active=True) & ~Q(is_staff=False)
    )
```

**Op√ß√µes de `on_delete`:**[8][9][10][11]
- `CASCADE` - Deleta os objetos relacionados
- `PROTECT` - Impede dele√ß√£o se houver relacionamentos
- `RESTRICT` - Similar ao PROTECT, mais restritivo
- `SET_NULL` - Define como NULL (requer `null=True`)
- `SET_DEFAULT` - Define valor padr√£o (requer `default`)
- `SET(value)` - Define valor espec√≠fico ou callable
- `DO_NOTHING` - N√£o faz nada (pode causar erro de integridade)

**Caracter√≠sticas:**[12][13][14]
- Cria coluna `campo_id` automaticamente no banco
- `to_field` permite referenciar campos √∫nicos diferentes da PK
- `db_constraint=False` remove constraint do banco (√∫til para legacy data)
- `related_name='+'` desabilita acesso reverso

#### 8.2. **OneToOneField**

Relacionamento um-para-um.

**Propriedades Espec√≠ficas:**
- **`on_delete`** - Comportamento ao deletar (obrigat√≥rio)
- **`related_name`** - Nome para acesso reverso
- **`related_query_name`** - Nome para queries reversas
- **`to_field`** - Campo referenciado
- **`db_constraint`** - Criar constraint no banco
- **`limit_choices_to`** - Limitar op√ß√µes
- **`parent_link`** - Se √© link para modelo pai em heran√ßa

```python
class Usuario(models.Model):
    nome = models.CharField(max_length=100)
    email = models.EmailField(unique=True)

class PerfilUsuario(models.Model):
    usuario = models.OneToOneField(
        Usuario,
        on_delete=models.CASCADE,
        primary_key=True,  # Usa a PK do usu√°rio
        related_name='perfil',  # usuario.perfil
        parent_link=False
    )
    telefone = models.CharField(max_length=15)
    data_nascimento = models.DateField()
```

**Caracter√≠sticas:**[15][16]
- Similar ao ForeignKey com `unique=True`
- Geralmente usado com `primary_key=True`
- Ideal para estender modelos existentes
- Acesso bidirecional: `usuario.perfil` e `perfil.usuario`

#### 8.3. **ManyToManyField**

Relacionamento muitos-para-muitos.

**Propriedades Espec√≠ficas:**
- **`related_name`** - Nome para acesso reverso
- **`related_query_name`** - Nome para queries reversas
- **`limit_choices_to`** - Limitar op√ß√µes
- **`symmetrical`** - Se relacionamento √© sim√©trico (padr√£o: True para 'self')
- **`through`** - Modelo intermedi√°rio customizado
- **`through_fields`** - Campos espec√≠ficos do modelo intermedi√°rio
- **`db_table`** - Nome da tabela intermedi√°ria
- **`db_constraint`** - Criar constraints no banco
- **`swappable`** - Se pode ser substitu√≠do

```python
class Autor(models.Model):
    nome = models.CharField(max_length=200)

class Categoria(models.Model):
    nome = models.CharField(max_length=100)

class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    
    # ManyToMany simples
    autores = models.ManyToManyField(
        Autor,
        related_name='livros',
        related_query_name='livro',
        blank=True,
        db_table='biblioteca_livro_autores'  # Nome customizado da tabela
    )
    
    # ManyToMany com modelo intermedi√°rio
    categorias = models.ManyToManyField(
        Categoria,
        through='LivroCategoria',
        related_name='livros'
    )
    
    # Auto-relacionamento sim√©trico
    livros_relacionados = models.ManyToManyField(
        'self',
        symmetrical=True,  # Se A relaciona B, B relaciona A
        blank=True
    )
    
    # Auto-relacionamento n√£o-sim√©trico
    livros_referenciados = models.ManyToManyField(
        'self',
        symmetrical=False,  # A pode referenciar B sem B referenciar A
        related_name='referenciado_por',
        blank=True
    )

class LivroCategoria(models.Model):
    """Modelo intermedi√°rio (through)"""
    livro = models.ForeignKey(Livro, on_delete=models.CASCADE)
    categoria = models.ForeignKey(Categoria, on_delete=models.CASCADE)
    principal = models.BooleanField(default=False)
    ordem = models.PositiveIntegerField(default=0)
```

**Caracter√≠sticas:**[17][18][19][20]
- Cria tabela intermedi√°ria automaticamente (ou usa `through`)
- `symmetrical=True`: para auto-relacionamentos sim√©tricos
- `symmetrical=False`: obrigat√≥rio ao usar `through`
- `through`: permite adicionar campos extras no relacionamento
- `through_fields`: especifica quais campos usar quando h√° ambiguidade
- `db_table`: nome customizado para tabela intermedi√°ria
- Com `through`, n√£o pode usar `.add()`, `.create()` ou `.set()` diretamente


## üè∑Ô∏è Propriedades Comuns a Todos os Campos

### 9.1 Propriedades de Valida√ß√£o

#### üõ∏ **null** e **blank**
```python
class Livro(models.Model):
    # null=True: permite NULL no banco de dados
    # blank=True: permite campo vazio em formul√°rios
    
    isbn = models.CharField(
        max_length=13,
        null=True,      # Pode ser NULL no banco
        blank=True      # Pode ser vazio no formul√°rio
    )
    
    # Para campos de texto, prefira blank=True, null=False
    subtitulo = models.CharField(
        max_length=200,
        blank=True,
        default=""  # Melhor que null=True para textos
    )
    
    # Para campos n√£o-texto, use null=True quando necess√°rio
    data_republicacao = models.DateField(
        null=True,
        blank=True
    )
```

#### üõ∏ **choices**
Define um conjunto fixo de op√ß√µes para o campo.

```python
class Livro(models.Model):
    class StatusEmprestimo(models.TextChoices):
        DISPONIVEL = 'DI', 'Dispon√≠vel'
        EMPRESTADO = 'EM', 'Emprestado'
        MANUTENCAO = 'MA', 'Em Manuten√ß√£o'
        PERDIDO = 'PE', 'Perdido'
    
    status = models.CharField(
        max_length=2,
        choices=StatusEmprestimo.choices,
        default=StatusEmprestimo.DISPONIVEL
    )
    
    # Usando IntegerChoices
    class CategoriaIdade(models.IntegerChoices):
        LIVRE = 0, 'Livre'
        MAIORES_10 = 10, 'Maiores de 10 anos'
        MAIORES_12 = 12, 'Maiores de 12 anos'
        MAIORES_16 = 16, 'Maiores de 16 anos'
        MAIORES_18 = 18, 'Maiores de 18 anos'
    
    classificacao = models.IntegerField(
        choices=CategoriaIdade.choices,
        default=CategoriaIdade.LIVRE
    )
```

#### üõ∏  **default**
Define um valor padr√£o para novos objetos.

```python
class Livro(models.Model):
    disponivel = models.BooleanField(default=True)
    exemplares = models.PositiveIntegerField(default=1)
    
    # Usando callable para valores din√¢micos
    def gerar_codigo():
        return f"LIV-{uuid.uuid4().hex[:8].upper()}"
    
    codigo = models.CharField(
        max_length=12,
        default=gerar_codigo,
        unique=True
    )
```

#### üõ∏ **validators**
Lista de fun√ß√µes de valida√ß√£o customizadas.

```python
from django.core.validators import (
    MinValueValidator,
    MaxValueValidator,
    RegexValidator,
    MinLengthValidator
)

class Livro(models.Model):
    ano_publicacao = models.PositiveIntegerField(
        validators=[
            MinValueValidator(1000, message="Ano muito antigo"),
            MaxValueValidator(2100, message="Ano inv√°lido")
        ]
    )
    
    isbn = models.CharField(
        max_length=13,
        validators=[
            RegexValidator(
                regex=r'^\d{13}$',
                message='ISBN deve conter exatamente 13 d√≠gitos',
                code='isbn_invalido'
            )
        ]
    )
    
    titulo = models.CharField(
        max_length=200,
        validators=[
            MinLengthValidator(3, message="T√≠tulo muito curto")
        ]
    )
```

### 9.2 Propriedades de Banco de Dados

#### üöÄ **db_column**
Define o nome da coluna no banco de dados.

```python
class Livro(models.Model):
    titulo = models.CharField(
        max_length=200,
        db_column='book_title'  # Nome da coluna no banco
    )
```

#### üöÄ **db_index**
Cria um √≠ndice no banco para melhorar performance de consultas.

```python
class Livro(models.Model):
    isbn = models.CharField(
        max_length=13,
        db_index=True,  # Cria √≠ndice para buscas r√°pidas
        unique=True
    )
```

#### üöÄ **db_comment**
Adiciona coment√°rios na coluna do banco.

```python
class Livro(models.Model):
    preco = models.DecimalField(
        max_digits=8,
        decimal_places=2,
        db_comment="Pre√ßo de venda do livro em reais"
    )
```

#### üöÄ **db_default**
Define valor padr√£o calculado pelo banco de dados.

```python
from django.db.models.functions import Now

class Emprestimo(models.Model):
    data_criacao = models.DateTimeField(
        db_default=Now()  # Usa fun√ß√£o do banco
    )
```

### 9.3. Propriedades de Formul√°rios

#### üõ∞Ô∏è **editable**
Controla se o campo aparece em formul√°rios.

```python
class Livro(models.Model):
    codigo_interno = models.CharField(
        max_length=20,
        editable=False  # N√£o aparece em formul√°rios
    )
```

#### üõ∞Ô∏è **help_text**
Texto de ajuda exibido nos formul√°rios.

```python
class Livro(models.Model):
    isbn = models.CharField(
        max_length=13,
        help_text="C√≥digo ISBN-13 sem h√≠fens ou espa√ßos"
    )
```

#### üõ∞Ô∏è **verbose_name**
Nome leg√≠vel para o campo.

```python
class Livro(models.Model):
    titulo = models.CharField(
        max_length=200,
        verbose_name="T√≠tulo do Livro"
    )
```

#### üõ∞Ô∏è **error_messages**
Personaliza mensagens de erro.

```python
class Usuario(models.Model):
    email = models.EmailField(
        unique=True,
        error_messages={
            'unique': 'Este e-mail j√° est√° cadastrado no sistema.',
            'invalid': 'Por favor, insira um e-mail v√°lido.',
            'required': 'O e-mail √© obrigat√≥rio.'
        }
    )
```

### 9.4. Propriedades de Chave

#### üîë **primary_key**
Define o campo como chave prim√°ria.

```python
class Livro(models.Model):
    isbn = models.CharField(
        max_length=13,
        primary_key=True  # Este ser√° a chave prim√°ria
    )
```

#### üîë **unique**
Garante que os valores sejam √∫nicos.

```python
class Autor(models.Model):
    cpf = models.CharField(
        max_length=11,
        unique=True
    )
```

## 10. Campos de Relacionamento

### 10.1. `ForeignKey` (Relacionamento Muitos-para-Um)

A `ForeignKey` representa um relacionamento onde **v√°rios registros** de um modelo podem estar associados a **um √∫nico registro** de outro modelo.

```python
class Editora(models.Model):
    nome = models.CharField(max_length=200)
    pais = models.CharField(max_length=100)
    
    class Meta:
        verbose_name_plural = "Editoras"
    
    def __str__(self):
        return self.nome

class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    
    # V√°rios livros podem ter a mesma editora
    editora = models.ForeignKey(
        Editora,
        on_delete=models.PROTECT,  # Impede deletar editora com livros
        related_name='livros',     # Acesso reverso
        related_query_name='livro' # Nome para queries
    )
    
    def __str__(self):
        return self.titulo
```

#### üîñ **Propriedades da ForeignKey**

üéØ **on_delete** - Define o comportamento quando o objeto referenciado √© deletado:

```python
class Livro(models.Model):
    # CASCADE: deleta os livros quando a editora for deletada
    editora = models.ForeignKey(
        Editora,
        on_delete=models.CASCADE
    )
    
    # PROTECT: impede deletar editora se houver livros
    editora = models.ForeignKey(
        Editora,
        on_delete=models.PROTECT
    )
    
    # SET_NULL: define editora como NULL quando deletada
    editora = models.ForeignKey(
        Editora,
        on_delete=models.SET_NULL,
        null=True
    )
    
    # SET_DEFAULT: define valor padr√£o quando deletada
    editora = models.ForeignKey(
        Editora,
        on_delete=models.SET_DEFAULT,
        default=1
    )
    
    # SET(): define valor customizado via fun√ß√£o
    def get_editora_padrao():
        return Editora.objects.get(nome="Editora Padr√£o")
    
    editora = models.ForeignKey(
        Editora,
        on_delete=models.SET(get_editora_padrao)
    )
    
    # RESTRICT: similar ao PROTECT, mas mais restritivo
    editora = models.ForeignKey(
        Editora,
        on_delete=models.RESTRICT
    )
    
    # DO_NOTHING: n√£o faz nada (pode causar erro de integridade)
    editora = models.ForeignKey(
        Editora,
        on_delete=models.DO_NOTHING
    )
```

üéØ **related_name** - Define o nome para acessar a rela√ß√£o reversa:

O par√¢metro **`related_name`** serve para dar um nome personalizado ao acesso reverso do relacionamento em modelos Django, ou seja, permite acessar de forma direta e clara, a partir do modelo relacionado, todos os objetos que apontam para ele por meio de um campo **ForeignKey**, **OneToOneField** ou **ManyToManyField**.

**Por que usar `related_name`?**
- Sem `related_name`, o Django cria um nome padr√£o do tipo `<modelo>_set` como atributo reverso. Por exemplo, se `Livro` tem um campo `autor = models.ForeignKey(Autor)`, voc√™ acessa todos os livros de um autor com `autor.livro_set.all()`.
- Ao definir `related_name='livros'` no campo `autor`, voc√™ pode acessar diretamente todos os livros daquele autor usando `autor.livros.all()`, tornando o c√≥digo mais claro e intuitivo.

**Para que serve?**
- **Torna o relacionamento reverso mais leg√≠vel** e sem ambiguidade, principalmente com m√∫ltiplos relacionamentos entre os mesmos modelos.
- **Evita conflitos de nomes** quando h√° mais de um campo de rela√ß√£o entre os mesmos modelos. Nesse caso, definir `related_name` √© obrigat√≥rio.

**Observa√ß√µes**
- Usar nomes claros para `related_name` √© uma boa pr√°tica para facilitar manuten√ß√£o e leitura do c√≥digo.[4]
- Se necess√°rio, √© poss√≠vel definir `related_name='+'` para eliminar completamente o acesso reverso.

**Exemplos 01**

```python
class Autor(models.Model):
    nome = models.CharField(max_length=100)

class Livro(models.Model):
    titulo = models.CharField(max_length=100)
    autor = models.ForeignKey(Autor, related_name='livros', on_delete=models.CASCADE)
```
Agora, √© poss√≠vel:

```python
autor = Autor.objects.get(nome="Machado de Assis")
meus_livros = autor.livros.all()  # Utiliza o related_name
```

**Exemplos 02** 
```python
class Editora(models.Model):
    nome = models.CharField(max_length=200)

class Livro(models.Model):
    editora = models.ForeignKey(
        Editora,
        on_delete=models.CASCADE,
        related_name='livros'  # Personalizado
    )

# Uso:
editora = Editora.objects.get(nome="Companhia das Letras")
livros = editora.livros.all()  # Usa related_name
livros_filtrados = editora.livros.filter(ano=2023)
```

üéØ **related_query_name** - Nome usado em queries reversas:

O par√¢metro **`related_query_name`** no Django ORM √© utilizado para definir o n**ome da rela√ß√£o reversa** quando voc√™ realiza consultas filtrando os objetos relacionados em `QuerySets`, ou seja, serve para criar filtros din√¢micos pelo lado oposto da rela√ß√£o.

Ao definir um campo de relacionamento (ex: ForeignKey, ManyToManyField) e usar `related_query_name`, voc√™ customiza a palavra-chave usada em `lookups` de consulta reversa (`filter`, `exclude` etc.).

**Exemplo 01**
Considere o seguinte modelo:

```python
class Autor(models.Model):
    nome = models.CharField(max_length=100)

class Livro(models.Model):
    titulo = models.CharField(max_length=100)
    autor = models.ForeignKey(
        Autor,
        related_name='livros',
        related_query_name='livro',
        on_delete=models.CASCADE
    )
```

Agora √© poss√≠vel:
```python
# Buscar autores com livros publicados em um determinado ano
autores = Autor.objects.filter(livro__ano_publicacao=2024)
```
Neste exemplo, `livro` √© o nome definido pelo `related_query_name`. Se n√£o fosse especificado, o Django usaria o nome padr√£o (ex: `livro_set`).

**Exemplo 02**
```python
class Livro(models.Model):
    editora = models.ForeignKey(
        Editora,
        on_delete=models.CASCADE,
        related_name='livros',
        related_query_name='livro'  # Para queries
    )

# Uso:
# Filtrar editoras que t√™m livros de 2023
editoras = Editora.objects.filter(livro__ano=2023)
```

**Resumo da finalidade**

- **Facilita e torna flex√≠vel a filtragem** dos modelos relacionados usando consultas din√¢micas.
- Permite personalizar o nome da rela√ß√£o reversa **usada em queries** (n√£o no atributo direto).
- Ajuda em projetos com m√∫ltiplos relacionamentos entre os mesmos modelos, evitando ambiguidades ou conflitos.


üéØ **limit_choices_to** - Limita as op√ß√µes dispon√≠veis:

O par√¢metro **`limit_choices_to`** em campos de relacionamento do Django ORM serve para **limitar as op√ß√µes exibidas no campo de formul√°rio** (como no Django Admin e em formul√°rios ModelForm) apenas aos objetos que atendam a certos crit√©rios espec√≠ficos. 

**Como funciona?**

- Voc√™ pode passar um dicion√°rio, um objeto `Q`, ou uma fun√ß√£o `callable` que retorna um filtro (`dict`, `Q` ou callable).
- Esses crit√©rios s√£o usados para filtrar o `queryset` das op√ß√µes dispon√≠veis para o campo no formul√°rio.
- Isso n√£o adiciona nenhuma restri√ß√£o ao banco de dados, √© apenas para facilitar a interface e evitar sele√ß√£o incorreta.
- Por exemplo, limitar selecion√°veis apenas objetos ativos, relacionados a outro objeto, ou que possuam determinada caracter√≠stica.

**Exemplo 01**

```python
from django.db.models import Q

class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    editora = models.ForeignKey(
        Editora, 
        on_delete=models.CASCADE,
        limit_choices_to={'ativa': True}  # Apenas editoras ativas para escolha
    )

class Emprestimo(models.Model):
    livro = models.ForeignKey(
        Livro,
        on_delete=models.CASCADE,
        limit_choices_to=Q(disponivel=True) & Q(exemplares_disponiveis__gt=0)  # Livros dispon√≠veis
    )
```

**Exemplo 02**

```python
from django.db.models import Q

class Emprestimo(models.Model):
    livro = models.ForeignKey(
        Livro,
        on_delete=models.CASCADE,
        # Apenas livros dispon√≠veis
        limit_choices_to={'disponivel': True}
    )
    
    # Com Q objects para queries complexas
    usuario = models.ForeignKey(
        Usuario,
        on_delete=models.CASCADE,
        limit_choices_to=Q(ativo=True) & Q(suspenso=False)
    )
```

**Considera√ß√µes importantes**

- No Django Admin, ou em formul√°rios padr√£o, o campo exibir√° apenas as op√ß√µes permitidas, facilitando a escolha correta.
- Em casos mais din√¢micos (como dependendo do usu√°rio logado), `limit_choices_to` pode ser usado com uma fun√ß√£o que recebe inst√¢ncia para ajuste din√¢mico - embora nesse caso, muitas vezes, seja melhor customizar o queryset do formul√°rio.
- N√£o garante integridade no banco, nem afeta queries diretas feitas programaticamente.
- Quando o filtro pode ser complexo, usar um objeto Q permite m√∫ltiplas condi√ß√µes l√≥gicas.

### 10.2. `OneToOneField` (Relacionamento Um-para-Um)

Usado quando **cada registro** de um modelo est√° relacionado a **exatamente um registro** de outro modelo.

```python
class Usuario(models.Model):
    nome = models.CharField(max_length=100)
    email = models.EmailField(unique=True)

class PerfilUsuario(models.Model):
    usuario = models.OneToOneField(
        Usuario,
        on_delete=models.CASCADE,
        primary_key=True,  # Usa a PK do usu√°rio
        related_name='perfil'
    )
    
    telefone = models.CharField(max_length=15)
    endereco = models.TextField()
    data_nascimento = models.DateField()
    
    def __str__(self):
        return f"Perfil de {self.usuario.nome}"
```

üîñ **Propriedades do OneToOneField:**
- Aceita as mesmas op√ß√µes que ForeignKey (on_delete, related_name, etc.)
- Geralmente usado com `primary_key=True` para compartilhar a chave prim√°ria
- √ötil para estender modelos sem modific√°-los diretamente

### 10.3. `ManyToManyField` (Relacionamento Muitos-para-Muitos)

Quando **m√∫ltiplos registros** de um modelo podem estar **relacionados a m√∫ltiplos registros** de outro modelo.

O campo **ManyToManyField** no Django ORM √© usado para representar um relacionamento muitos-para-muitos entre dois modelos. Isso significa que um registro de um modelo pode estar associado a v√°rios registros de outro modelo e vice-versa.

**Como funciona internamente?**

- O Django cria automaticamente uma **tabela intermedi√°ria** (tamb√©m chamada de "`through table`") no banco de dados, que armazena as refer√™ncias (chaves estrangeiras) dos dois modelos relacionados.
- Essa tabela n√£o √© um modelo Django expl√≠cito (a menos que voc√™ crie um modelo intermedi√°rio customizado), mas gerencia a rela√ß√£o muitos-para-muitos.
- Essa estrutura permite consultas eficientes e a associa√ß√£o de m√∫ltiplos objetos em ambas as dire√ß√µes.

**Exemplo 01**

```python
class Autor(models.Model):
    nome = models.CharField(max_length=100)

class Livro(models.Model):
    titulo = models.CharField(max_length=100)
    autores = models.ManyToManyField(Autor, related_name='livros')
```

Aqui, um livro pode ter v√°rios autores e um autor pode estar associado a v√°rios livros.

Usos pr√°ticos:

- Acesso a autores de um livro: `livro.autores.all()`
- Acesso a livros de um autor: `autor.livros.all()` (aqui `livros` √© o `related_name`)
- Adicionar ou remover rela√ß√µes: `livro.autores.add(autor)`, `livro.autores.remove(autor)

**Exemplo 02**

```python
class Autor(models.Model):
    nome = models.CharField(max_length=200)
    
    def __str__(self):
        return self.nome

class Categoria(models.Model):
    nome = models.CharField(max_length=100)
    
    class Meta:
        verbose_name_plural = "Categorias"
    
    def __str__(self):
        return self.nome

class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    
    # Um livro pode ter v√°rios autores
    # Um autor pode ter v√°rios livros
    autores = models.ManyToManyField(
        Autor,
        related_name='livros',
        blank=True
    )
    
    # Um livro pode ter v√°rias categorias
    categorias = models.ManyToManyField(
        Categoria,
        related_name='livros',
        blank=True
    )
```

**Propriedades importantes do ManyToManyField:**

- `related_name`: nome para acesso reverso.
- `related_query_name`: nome usado para consultas reversas.
- `limit_choices_to`: limita op√ß√µes exibidas em formul√°rios.
- `symmetrical`: define se a rela√ß√£o √© sim√©trica (√∫til em auto-relacionamentos).
- `through`: permite especificar modelo intermedi√°rio customizado para armazenar campos extras na rela√ß√£o.
- `through_fields`: define quais campos do modelo intermedi√°rio se relacionam com os modelos principais.
- `db_table`: nome da tabela intermedi√°ria no banco.
- `blank`: indica se o campo pode ficar vazio em formul√°rios.



#### 10.3.1. `Through Model` - Tabela Intermedi√°ria Customizada

Quando voc√™ precisa armazenar informa√ß√µes adicionais sobre o relacionamento:

```python
class Livro(models.Model):
    titulo = models.CharField(max_length=200)

class Autor(models.Model):
    nome = models.CharField(max_length=200)

class Autoria(models.Model):
    """Modelo intermedi√°rio para armazenar informa√ß√µes da autoria"""
    livro = models.ForeignKey(
        Livro,
        on_delete=models.CASCADE
    )
    autor = models.ForeignKey(
        Autor,
        on_delete=models.CASCADE
    )
    
    # Campos adicionais sobre o relacionamento
    ordem = models.PositiveIntegerField(
        default=1,
        help_text="Ordem do autor na lista"
    )
    tipo_contribuicao = models.CharField(
        max_length=50,
        choices=[
            ('principal', 'Autor Principal'),
            ('coautor', 'Coautor'),
            ('organizador', 'Organizador'),
            ('tradutor', 'Tradutor')
        ],
        default='principal'
    )
    data_colaboracao = models.DateField(auto_now_add=True)
    
    class Meta:
        ordering = ['livro', 'ordem']
        unique_together = ['livro', 'autor']
    
    def __str__(self):
        return f"{self.autor.nome} - {self.livro.titulo}"

class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    
    # Especifica o through model
    autores = models.ManyToManyField(
        Autor,
        through='Autoria',
        related_name='livros'
    )
```

üèóÔ∏è **Trabalhando com Through Models:**

```python
# Criar um livro
livro = Livro.objects.create(titulo="Django para Iniciantes")

# Criar autores
autor1 = Autor.objects.create(nome="Jo√£o Silva")
autor2 = Autor.objects.create(nome="Maria Santos")

# Adicionar autores COM informa√ß√µes extras
Autoria.objects.create(
    livro=livro,
    autor=autor1,
    ordem=1,
    tipo_contribuicao='principal'
)

Autoria.objects.create(
    livro=livro,
    autor=autor2,
    ordem=2,
    tipo_contribuicao='coautor'
)

# Acessar os autores
for autoria in livro.autoria_set.all():
    print(f"{autoria.ordem}. {autoria.autor.nome} ({autoria.tipo_contribuicao})")
```

üîñ **Propriedades do ManyToManyField:**

- `symmetrical`: Para auto-relacionamentos, define se √© sim√©trico (padr√£o: True)
- `through`: Especifica o modelo intermedi√°rio customizado
- `through_fields`: Especifica quais campos usar em modelos intermedi√°rios complexos
- `db_table`: Nome da tabela intermedi√°ria no banco

```python
class Usuario(models.Model):
    nome = models.CharField(max_length=100)
    
    # Auto-relacionamento sim√©trico
    amigos = models.ManyToManyField(
        'self',
        symmetrical=True,  # Se A √© amigo de B, B √© amigo de A
        blank=True
    )
    
    # Auto-relacionamento n√£o-sim√©trico
    seguindo = models.ManyToManyField(
        'self',
        symmetrical=False,  # A pode seguir B sem B seguir A
        related_name='seguidores',
        blank=True
    )
```