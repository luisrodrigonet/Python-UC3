# Django ORM: Mapeamento Objeto-Relacional Completo

O Django ORM (`Object-Relational Mapper`) √© uma das ferramentas mais poderosas do framework Django. Ele permite que voc√™ **interaja com o banco de dados usando c√≥digo Python** orientado a objetos, **sem necessidade de escrever SQL diretamente**. O ORM traduz suas **classes Python em tabelas de banco de dados** e suas opera√ß√µes em Python para queries SQL.

Para contextualizar os conceitos que vamos aprender, vamos desenvolver uma aplica√ß√£o de **gest√£o de biblioteca**, que inclui modelos para livros, autores, editoras, empr√©stimos e usu√°rios.

## 13. Meta Options - Op√ß√µes de Metadados

As **Meta Options** ou **Op√ß√µes de Metadados** no Django s√£o configura√ß√µes definidas dentro da classe interna `Meta` de um modelo, que controlam aspectos importantes do comportamento do modelo, como nome da tabela no banco, ordena√ß√£o padr√£o, restri√ß√µes, permiss√µes, e outras caracter√≠sticas estruturais e administrativas.

üö® **O que s√£o as Meta Options?**

- S√£o atributos configurados em uma classe filha chamada `Meta` dentro da defini√ß√£o do modelo.
- Controlam par√¢metros que o Django usa para criar a tabela no banco de dados e para gerenciar o comportamento dos objetos dessa tabela.
- N√£o representam campos da tabela, mas sim configura√ß√µes do modelo.

üíª **Exemplo geral de estrutura:**

```python
class MeuModelo(models.Model):
    # campos...

    class Meta:
        ordering = ['nome']
        verbose_name = 'Meu modelo'
        # etc...
```


### 13.1 `abstract`

- **O que faz**: 
  - Diz que o modelo √© ‚Äúabstrato‚Äù, ou seja, n√£o cria tabela no banco. 
  - Ele serve apenas como classe base para outros modelos herdarem campos e op√ß√µes.
 
- **Uso t√≠pico**:
  - Voc√™ cria um modelo base com campos comuns (ex.: `criado_em`, `atualizado_em`) e faz outros modelos herdarem dele.
  

üíª **Exemplo:**

```python
class BaseAudit(models.Model):
    criado_em = models.DateTimeField(auto_now_add=True)
    atualizado_em = models.DateTimeField(auto_now=True)

    class Meta:
        abstract = True

class Post(BaseAudit):
    titulo = models.CharField(max_length=200)
    # Post ter√° criado_em e atualizado_em, mas BaseAudit n√£o cria tabela
```

### 13.2. `app_label`
- O que faz: 
  - Diz a qual app o modelo pertence, quando ele est√° definido fora da pasta do app.

- Uso t√≠pico:
  - Model definido em arquivo ‚Äúcompartilhado‚Äù, fora do app Django.

üíª **Exemplo:**

```python
class Cliente(models.Model):
    nome = models.CharField(max_length=100)

    class Meta:
        app_label = 'vendas'  # finge que este modelo est√° no app 'vendas'
```

### 13.3. `base_manager_name`
- O que faz: 
	- define qual manager ser√° o ‚Äúmanager base‚Äù usado pelo ORM (por exemplo em heran√ßa, queries internas).
	
- Uso t√≠pico:
  - Quando voc√™ tem mais de um manager e quer que o Django use outro em opera√ß√µes internas.
  


```python
class AtivoManager(models.Manager):
    def get_queryset(self):
        return super().get_queryset().filter(ativo=True)

class Produto(models.Model):
    ativo = models.BooleanField(default=True)
    objects = models.Manager()
    ativos = AtivoManager()

    class Meta:
        base_manager_name = 'objects'  # for√ßa o Django a usar 'objects' como manager base
```     

### 13.4. `default_manager_name`

- O que faz: 
	- define qual manager ser√° considerado o ‚Äúmanager padr√£o‚Äù (o acessado como `Modelo.objects`).

- Uso t√≠pico:
  - Quando voc√™ quer que `objects` na verdade seja um manager customizado.


```python
class AtivoManager(models.Manager):
    def get_queryset(self):
        return super().get_queryset().filter(ativo=True)

class Produto(models.Model):
    ativo = models.BooleanField(default=True)
    ativos = AtivoManager()
    todos = models.Manager()

    class Meta:
        default_manager_name = 'ativos'  # Produto.objects == Produto.ativos
```

### 13.5. `db_table`

- O que faz: 
	- define o nome da tabela no banco de dados.

- Uso t√≠pico:
  - Integrar com base legada, ou usar conven√ß√£o pr√≥pria de nomes.


```python
class Cliente(models.Model):
    nome = models.CharField(max_length=100)

    class Meta:
        db_table = 'tb_clientes'
```

### 13.6. `db_tablespace`

- O que faz: 
	- define o ‚Äútablespace‚Äù de banco (recurso avan√ßado de alguns bancos, como Oracle).

- Uso t√≠pico:
  - Projetos que usam tablespaces (bem espec√≠fico).



```python
class Log(models.Model):
    mensagem = models.TextField()

    class Meta:
        db_tablespace = 'logs_tablespace'
```

### 13.7. `default_related_name`
- O que faz: 
	- define qual nome ser√° usado para o ‚Äúlado reverso‚Äù de relacionamentos (em vez de `modelname_set` padr√£o).

- Uso t√≠pico:
  - Melhorar legibilidade ao acessar relacionamentos reversos.


```python
class Categoria(models.Model):
    nome = models.CharField(max_length=100)

    class Meta:
        default_related_name = 'categorias'  # usado em FKs para Categoria

class Post(models.Model):
    categoria = models.ForeignKey(Categoria, on_delete=models.CASCADE)
    # Agora Categoria.categorias.all() n√£o ‚Äì isso √© confuso para este exemplo.
    # Mais t√≠pico:
class Post(models.Model):
    categoria = models.ForeignKey(Categoria, on_delete=models.CASCADE, related_name='posts')

# Usando default_related_name num modelo:
class Autor(models.Model):
    nome = models.CharField(max_length=100)

    class Meta:
        default_related_name = 'posts'

class Post(models.Model):
    autor = models.ForeignKey(Autor, on_delete=models.CASCADE)
# Agora autor.posts.all() funciona sem precisar de related_name no campo.
```

### 13.8. `get_latest_by`
- O que faz: 
	- define qual campo ser√° usado pelo m√©todo `Model.objects.latest()` e `earliest()`.
	
- Uso t√≠pico:
  - Trabalhar com ‚Äú√∫ltimo registro‚Äù baseado em data/hora ou numera√ß√£o.
  
```python
class Post(models.Model):
    titulo = models.CharField(max_length=200)
    publicado_em = models.DateTimeField()

    class Meta:
        get_latest_by = 'publicado_em'

# Uso:
Post.objects.latest()  # pega o post mais recente por publicado_em
```

### 13.9. `managed`
- O que faz: 
	- se `False`, o Django N√ÉO cria/alterar tabela via migrations para esse modelo.
	
- Uso t√≠pico:
  - Mapear tabelas j√° existentes em banco legado, sem o Django ‚Äúmandar‚Äù nesse schema.


```python
class RelatorioFinanceiro(models.Model):
    codigo = models.IntegerField(primary_key=True)
    valor = models.DecimalField(max_digits=10, decimal_places=2)

    class Meta:
        managed = False
        db_table = 'relatorio_financeiro_legacy'
```

### 13.10. `order_with_respect_to`

- O que faz: 
	- adiciona ordena√ß√£o ‚Äúpor rela√ß√£o‚Äù. 
	- O Django cria um campo `_order` interno para manter a ordem dos objetos relacionados a outro.

- Uso t√≠pico:
  - Quando voc√™ quer ordenar itens dentro de um pai espec√≠fico (ex.: perguntas dentro de um question√°rio).

```python
class Pergunta(models.Model):
    questionario = models.ForeignKey('Questionario', on_delete=models.CASCADE)
    texto = models.CharField(max_length=200)

    class Meta:
        order_with_respect_to = 'questionario'
```

### 13.11. `ordering`

- O que faz: 
	- define a ordena√ß√£o padr√£o quando voc√™ faz `Model.objects.all()` (e outras queries).

- Uso t√≠pico:
  - Garantir sempre a mesma ordem (por data, nome, etc.).



```python
class Post(models.Model):
    titulo = models.CharField(max_length=200)
    publicado_em = models.DateTimeField(null=True, blank=True)

    class Meta:
        ordering = ['-publicado_em', 'titulo']
```

### 13.12. `permissions`
- O que faz: 
	- cria permiss√µes extras al√©m das 4 padr√µes (add, change, delete, view).
	
- Uso t√≠pico:
  - Criar permiss√µes de neg√≥cio, como ‚Äúpode publicar post‚Äù.

```python
class Post(models.Model):
    # campos...

    class Meta:
        permissions = [
            ('pode_publicar_post', 'Pode publicar posts'),
            ('pode_aprovar_post', 'Pode aprovar posts'),
        ]
```

### 13.13. `default_permissions`
- O que faz: 
	- define quais permiss√µes padr√£o ser√£o criadas. 
	- Por padr√£o: `('add', 'change', 'delete', 'view')`.
	
- Uso t√≠pico:
  - Remover ou ajustar permiss√µes padr√£o.
  

```python
class LogSistema(models.Model):
    # campos...

    class Meta:
        default_permissions = ()  # n√£o cria add/change/delete/view
```

### 13.14. `proxy`
- O que faz: 
	- se `True`, o modelo √© um ‚Äúproxy‚Äù de outro: mesma tabela, comportamento diferente (managers, m√©todos, Meta).
	
- Uso t√≠pico:
  - Criar ‚Äúvis√µes‚Äù diferentes do mesmo modelo com ordena√ß√£o/manager personalizados.

```python
class Post(models.Model):
    titulo = models.CharField(max_length=200)
    publicado = models.BooleanField(default=False)

class PostPublicado(Post):
    class Meta:
        proxy = True
        ordering = ['titulo']

    objects = models.Manager().filter(publicado=True)
```

### 13.15. `required_db_features` / `required_db_vendor`

- O que fazem:
  - `required_db_features`: lista de ‚Äúfeatures‚Äù que o banco de dados precisa ter para esse modelo ser usado (coisa avan√ßada).
  - `required_db_vendor`: restringe modelo a um tipo de banco (ex.: 'postgresql').

- Uso t√≠pico:
  - Funcionalidades muito espec√≠ficas de um tipo de banco.

```python
class ModeloPostgres(models.Model):
    dado = models.JSONField()

    class Meta:
        required_db_vendor = 'postgresql'
```

### 13.16. `select_on_save`
- O que faz: 
	- for√ßa o Django a recarregar o objeto do banco ap√≥s salvar, usando `SELECT` com `FOR UPDATE` em alguns backends.
- Uso t√≠pico:
  - Casos raros, para evitar condi√ß√µes de corrida em updates complexos.


### 13.17. `indexes`
- O que faz: 
	- define √≠ndices adicionais de banco para o modelo (semelhante a criar √≠ndices no SQL).

- Uso t√≠pico:
  - Melhorar performance de buscas em campos espec√≠ficos.

```python
from django.db import models

class Cliente(models.Model):
    primeiro_nome = models.CharField(max_length=100)
    sobrenome = models.CharField(max_length=100)
    email = models.EmailField(unique=True)

    class Meta:
        indexes = [
            models.Index(fields=['sobrenome', 'primeiro_nome']),
            models.Index(fields=['email'], name='idx_cliente_email'),
        ]
```

### 13.18. `constraints`

- O que faz: 
	- define restri√ß√µes de banco, como `CHECK`, `UNIQUE` compostas, `ForeignKey` condicional etc.

- Uso t√≠pico:
  - Garantir regras de integridade diretamente no banco (por exemplo, idade m√≠nima).

```python
from django.db import models
from django.db.models import Q

class Cliente(models.Model):
    nome = models.CharField(max_length=100)
    idade = models.IntegerField()

    class Meta:
        constraints = [
            models.CheckConstraint(
                check=Q(idade__gte=18),
                name='idade_maior_ou_igual_18',
            ),
        ]
```

### 13.19. `unique_together` (considerada legacy)
- O que faz: 
	- define combina√ß√£o de campos que deve ser √∫nica (n√£o pode repetir).
	- Hoje √© recomend√°vel usar `UniqueConstraint` em `constraints`, mas `unique_together` ainda funciona.

```python
class Inscricao(models.Model):
    aluno = models.ForeignKey('Aluno', on_delete=models.CASCADE)
    curso = models.ForeignKey('Curso', on_delete=models.CASCADE)

    class Meta:
        unique_together = ('aluno', 'curso')
```

### 13.20. `index_together` (legacy)
- O que faz: 
	- cria √≠ndices combinados em m√∫ltiplos campos. 
	- Hoje se prefere `indexes`.

```python
class Pedido(models.Model):
    cliente = models.ForeignKey('Cliente', on_delete=models.CASCADE)
    data = models.DateField()

    class Meta:
        index_together = (
            ('cliente', 'data'),
        )
```

### 13.21. verbose_name
- O que faz: 
	- nome leg√≠vel (singular) do modelo, usado no admin e mensagens.

- Uso t√≠pico:
  - Traduzir ou deixar mais amig√°vel.


```python
class Post(models.Model):
    # campos...

    class Meta:
        verbose_name = 'Post'
```

### 13.22. verbose_name_plural
- O que faz: 
	- nome leg√≠vel (plural) do modelo.

- Uso t√≠pico:
  - Ajustar plurais que n√£o seguem a regra ‚Äúsimples‚Äù.


```python
class Post(models.Model):
    # campos...

    class Meta:
        verbose_name = 'Post'
        verbose_name_plural = 'Posts'
```

### 13.23.  label / label_lower (s√≥ leitura, n√£o se define em Meta)
- N√£o s√£o op√ß√µes que voc√™ define; s√£o atributos calculados:
  - `model._meta.label` ‚Üí "app.ModelName" (ex.: "blog.Post").
  - `model._meta.label_lower` ‚Üí "app.modelname" (ex.: "blog.post").

### 13.24. verbose_name_raw (interno)
- Atributo interno relacionado √† forma ‚Äúcrua‚Äù do verbose_name; n√£o √© comum mexer nisso direto.

### 13.25. auto_created, default_apps, etc. (internos)
- S√£o atributos que o Django usa internamente na API `_meta`; n√£o s√£o op√ß√µes que voc√™ normalmente configura na classe `Meta`.


### üö® As mais usadas no dia a dia

Resumo das mais usadas no dia a dia:
- ordering
- verbose_name / verbose_name_plural
- db_table (quando integra com BD legado)
- constraints / unique_together
- indexes
- permissions / default_permissions
- abstract
- proxy
- managed
- get_latest_by


Aqui est√° uma tabela-resumo com as op√ß√µes Meta mais importantes para modelos Django, explicando para que servem, quando usar, e exemplos pr√°ticos. 

| Op√ß√£o Meta       | O que faz                                                                 | Quando usar / Por qu√™                                                                                          | Exemplo b√°sico                                                                                     |
|------------------|---------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------|
| `abstract`       | Indica que o modelo √© abstrato (n√£o cria tabela no BD)                    | Criar classe base para heran√ßa com campos comuns, evitando duplica√ß√µes                                       | `class Base(models.Model): class Meta: abstract = True`                                         |
| `db_table`       | Define nome espec√≠fico da tabela no banco                                | Integrar com bancos legados ou padronizar nomea√ß√£o                                                           | `db_table = 'tb_posts'`                                                                          |
| `ordering`       | Define ordena√ß√£o padr√£o (ordem dos objetos nas consultas)                | Garantir ordem consistente (ex: do mais novo para o mais antigo)                                             | `ordering = ['-criado_em']`                                                                      |
| `verbose_name`   | Nome leg√≠vel singular do modelo para admin e mensagens                   | Tornar nomes de modelos amig√°veis e localizados                                                              | `verbose_name = 'Post'`                                                                          |
| `verbose_name_plural` | Nome leg√≠vel plural do modelo para admin                            | Ajustar plural que n√£o seja s√≥ adicionar ‚Äús‚Äù (ex: ‚ÄúPa√≠s‚Äù ‚Üí ‚ÄúPa√≠ses‚Äù)                                         | `verbose_name_plural = 'Posts'`                                                                 |
| `unique_together`| Garante que combina√ß√£o de valores em campos seja √∫nica                   | Restringir duplicatas combinadas (ex: evitar aluno inscrito 2x no mesmo curso)                                | `unique_together = ('aluno', 'curso')`                                                          |
| `indexes`        | Cria √≠ndices em campos para melhorar performance em buscas               | Otimizar consultas frequentes em grandes tabelas                                                             | `indexes = [models.Index(fields=['email'])]`                                                    |
| `constraints`    | Define restri√ß√µes como CHECK, UNIQUE compostas                           | Garantir regras espec√≠ficas no banco (ex: idade >= 18)                                                       | `constraints = [models.CheckConstraint(check=Q(idade__gte=18), name="idade_minima")]`            |
| `get_latest_by`  | Define campo para usar em `latest()` e `earliest()`                      | Facilitar recupera√ß√£o do registro mais recente ou mais antigo                                                | `get_latest_by = 'publicado_em'`                                                                 |
| `managed`        | Se False, Django n√£o cria/altera tabela via migrations                    | Mapear tabelas existentes sem gerenciar cria√ß√£o/modifica√ß√£o                                                   | `managed = False`                                                                                |
| `proxy`          | Cria modelo proxy para mesmo banco, comportamento diferente             | Criar vers√µes diferentes do mesmo modelo para l√≥gicas distintas                                             | `proxy = True`                                                                                   |
| `permissions`    | Cria permiss√µes extras al√©m das padr√£o (add, change, delete, view)       | Permiss√µes espec√≠ficas para regras de neg√≥cio (ex: ‚Äúpode_publicar_post‚Äù)                                     | `permissions = [('pode_publicar_post', 'Pode publicar posts')]`                                 |
| `default_permissions` | Define quais permiss√µes padr√£o criar (padr√£o: add, change, delete, view) | Remover permiss√£o desnecess√°ria                                                                              | `default_permissions = ()`                                                                       |
| `default_related_name` | Nome padr√£o para acesso reverso de relacionamentos                 | Melhorar legibilidade em rela√ß√µes reversas sem sempre definir related_name                                  | `default_related_name = 'posts'`                                                                |
| `base_manager_name` | Define manager base para opera√ß√µes internas                            | Escolher qual manager usar para consultas internas                                                          | `base_manager_name = 'objects'`                                                                 |
| `default_manager_name` | Define manager padr√£o (`objects`)                                   | Definir manager padr√£o em projetos com v√°rios managers                                                        | `default_manager_name = 'ativos'`                                                               |
| `app_label`      | Define a que app pertence o modelo                                      | Quando o modelo est√° fora do diret√≥rio padr√£o do app                                                        | `app_label = 'blog'`                                                                             |

Essa tabela cobre as op√ß√µes mais comuns utilizadas em projetos que incluem modelos como posts, categorias, usu√°rios, coment√°rios, produtos e outros.

üíª **Exemplo 01**

```python
class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    isbn = models.CharField(max_length=13, unique=True)
    ano_publicacao = models.PositiveIntegerField()
    editora = models.ForeignKey(Editora, on_delete=models.CASCADE)
    
    class Meta:
        # Nome da tabela no banco
        db_table = 'biblioteca_livros'
        
        # Nomes leg√≠veis
        verbose_name = 'Livro'
        verbose_name_plural = 'Livros'
        
        # Ordena√ß√£o padr√£o
        ordering = ['-ano_publicacao', 'titulo']
        
        # Campos √∫nicos em conjunto
        unique_together = [['titulo', 'editora', 'ano_publicacao']]
        
        # √çndices compostos
        indexes = [
            models.Index(fields=['titulo', 'ano_publicacao']),
            models.Index(fields=['-ano_publicacao']),
        ]
        
        # Permiss√µes customizadas
        permissions = [
            ('pode_emprestar', 'Pode emprestar livros'),
            ('pode_reservar', 'Pode reservar livros'),
        ]
        
        # Restri√ß√µes
        constraints = [
            models.CheckConstraint(
                check=models.Q(preco__gte=0),
                name='preco_positivo'
            ),
            models.UniqueConstraint(
                fields=['isbn'],
                name='isbn_unico'
            )
        ]
```

üíª **Exemplo 02**

```python
class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    ano_publicacao = models.PositiveIntegerField()
    
    class Meta:
        # Define o nome da tabela no banco (por padr√£o √© app_modelo)
        db_table = 'biblioteca_livros'
        
        # Ordena√ß√£o padr√£o nas consultas (ascendente por titulo)
        ordering = ['titulo']
        
        # Nome leg√≠vel para o modelo (singular)
        verbose_name = 'Livro'
        
        # Nome leg√≠vel para o modelo (plural)
        verbose_name_plural = 'Livros'
        
        # Define conjunto de campos que devem ser √∫nicos juntos (√≠ndice composto)
        unique_together = [['titulo', 'ano_publicacao']]
        
        # √çndices adicionais criados no banco para performance
        indexes = [
            models.Index(fields=['ano_publicacao']),
        ]
        
        # Permiss√µes extras criadas junto com as permiss√µes padr√£o
        permissions = [
            ('pode_emprestar', 'Pode emprestar livros'),
            ('pode_reservar', 'Pode reservar livros'),
        ]
        
        # Campo padr√£o para usar no m√©todo latest()
        get_latest_by = 'ano_publicacao'
        
        # Op√ß√£o usada para ordenar objetos que s√£o relacionados a objetos pais
        order_with_respect_to = 'categoria'
```

ü§ñ **Outras op√ß√µes comuns**

- `db_tablespace`: nome do tablespace no banco (em bancos que suportam).
- `default_related_name`: nome padr√£o para acessos reversos de ForeignKey e ManyToMany.
- `managed`: se Django deve criar/alterar a tabela automaticamente (padr√£o True).
- `proxy`: define modelo proxy para usar outra tabela sem criar nova.
- `abstract`: define modelo abstrato que n√£o gera tabela, usado para heran√ßa.
- `swappable`: permite trocar o modelo (usado pelo User).

üöè **Por que usar Meta Options?**

- Organiza configura√ß√µes fundamentais do modelo em um local central e bem definido.
- Permite personalizar o comportamento padr√£o do Django sobre o mapeamento para banco, evitando c√≥digos repetitivos.
- D√° controle sobre nomes, √≠ndices, garantias de integridade e permiss√µes sem mexer com SQL diretamente.
- Facilita integra√ß√£o com Django Admin e outros componentes do framework.

Em resumo, as **Meta Options** s√£o par√¢metros configur√°veis cr√≠ticos que definem como o Django deve tratar um modelo no contexto do banco de dados e da aplica√ß√£o. Elas s√£o essenciais para definir comportamentos avan√ßados e otimizar o uso dos modelos na aplica√ß√£o web.