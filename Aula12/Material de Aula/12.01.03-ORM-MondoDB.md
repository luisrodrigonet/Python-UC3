
# 12.02.03  : ORM - MongoDB - Vis√£o Geral

### ü§î O que √© o MongoDB? Uma Nova Forma de Pensar em Bancos de Dados

O MongoDB √© um dos bancos de dados **NoSQL** mais populares do mundo. A sigla "**NoSQL**" significa "**Not Only SQL**" (N√£o Apenas SQL), o que j√° nos d√° uma pista de sua principal caracter√≠stica: ele n√£o segue a estrutura r√≠gida de tabelas, linhas e colunas dos bancos de dados relacionais tradicionais (como **MySQL**, **PostgreSQL**, etc.).

Em vez disso, o MongoDB √© um **banco de dados orientado a documentos**.

Imagine a seguinte analogia:

  * **Banco de Dados SQL:** √â como uma planilha do Excel. Voc√™ define colunas fixas (`ID`, `Nome`, `Email`) e cada linha deve seguir essa estrutura. Mudar a estrutura (adicionar uma coluna) √© uma opera√ß√£o complexa.
  
  * **MongoDB:** √â como uma pasta cheia de documentos de texto (no formato JSON). Cada documento tem sua pr√≥pria estrutura. Um documento pode ter os campos `nome` e `email`, enquanto outro na mesma "pasta" pode ter `nome`, `email`, `telefone` e uma lista de `hobbies`. Essa flexibilidade √© extremamente poderosa.

Para facilitar a transi√ß√£o, veja uma compara√ß√£o dos termos:

| Conceito em SQL | Equivalente em MongoDB üåé | Descri√ß√£o |
| :--- | :--- | :--- |
| Tabela | **Cole√ß√£o (Collection)** | Um agrupamento de documentos. |
| Linha (Row) | **Documento (Document)** | Uma √∫nica entrada de dados, no formato BSON. |
| Coluna (Column) | **Campo (Field)** | Um par de chave-valor dentro de um documento. |
| Chave Prim√°ria | **`_id`** | Um campo √∫nico que identifica cada documento. |
| Joins | **Documentos Embutidos / Agrega√ß√µes** | Rela√ß√µes s√£o feitas embutindo um documento em outro ou atrav√©s de consultas especiais. |

### üß± Os Blocos de Constru√ß√£o do MongoDB

* **Documento:** A unidade b√°sica de dados no MongoDB. 
  
  √â um conjunto de pares chave-valor, muito parecido com um objeto JSON. Na verdade, o MongoDB armazena os dados em **BSON** (Binary JSON), uma vers√£o bin√°ria do JSON que suporta mais tipos de dados.

    ```json
    {
      "titulo": "Matrix",
      "ano_lancamento": 1999,
      "genero": ["Fic√ß√£o Cient√≠fica", "A√ß√£o"],
      "diretor": {
        "nome": "Lana Wachowski",
        "nascimento": "1965-06-21"
      }
    }
    ```

* **Cole√ß√£o (Collection):** Um agrupamento de documentos. 

    Seria o equivalente a uma tabela em SQL, mas sem a obrigatoriedade de um esquema fixo. Voc√™ pode ter v√°rios documentos com estruturas diferentes na mesma cole√ß√£o.

* **O `_id` M√°gico:** Todo documento em uma cole√ß√£o precisa ter um campo `_id` que funcione como sua chave prim√°ria. 
    
    Se voc√™ n√£o fornecer um valor para o `_id` ao inserir um novo documento, o MongoDB criar√° automaticamente um `ObjectId` √∫nico para ele.



### ‚ú® Por que escolher o MongoDB? As Vantagens

* **Flexibilidade de Esquema (Schema):** 
    - Como vimos, voc√™ n√£o precisa definir a estrutura dos seus dados de antem√£o. 
    - Isso permite que sua aplica√ß√£o evolua de forma muito mais r√°pida e f√°cil.
    
* **Escalabilidade Horizontal:** 
    - MongoDB foi projetado desde o in√≠cio para escalar horizontalmente. 
    - Isso significa que, em vez de comprar um servidor cada vez mais caro e potente (**escala vertical**), voc√™ pode distribuir sua carga de dados por v√°rios servidores mais baratos (**escala horizontal**), um processo chamado *`sharding`*.
    
* **Performance:** 
    - Para muitos casos de uso, especialmente aqueles com grandes volumes de leitura e escrita, o MongoDB pode oferecer uma performance superior √† de bancos de dados relacionais.
    
* **Consultas Ricas e Intuitivas:** 
    - A linguagem de consulta do MongoDB √© poderosa e permite filtrar documentos por campos, faixas de valores e at√© mesmo por conte√∫do dentro de arrays ou documentos embutidos.

### üöÄ Usando o MongoDB Atlas (a Nuvem)

A maneira mais f√°cil e recomendada de come√ßar a usar o MongoDB √© atrav√©s do **MongoDB Atlas**, a plataforma de banco de dados como servi√ßo (DBaaS) oficial. Ela oferece um n√≠vel gratuito (`M0 Free Tier`) perfeito para aprender e para projetos pequenos.

1.  **Crie uma Conta:** Acesse o [site do MongoDB Atlas](https://www.mongodb.com/cloud/atlas) e crie uma conta gratuita.

2.  **Crie um Cluster:** 
    - Ap√≥s o registro, **crie um novo projeto** e, dentro dele, um "**`Cluster`**".
    - **Escolha um** provedor de nuvem (AWS, Google Cloud ou Azure) e **uma regi√£o**.
    - Selecione o tier **`M0`**, que √© gratuito.

3.  **Crie um Usu√°rio:** 
    - Na se√ß√£o "`Database Access`", crie um usu√°rio e senha. 
    - Voc√™ usar√° isso para se conectar ao banco de dados.

4.  **Libere o Acesso de Rede:** 
    - Na se√ß√£o "`Network Access`", adicione seu endere√ßo de IP √† lista de acesso para permitir que sua m√°quina se conecte ao cluster.

5.  **Obtenha a Connection String:** 
    - Na vis√£o geral do seu cluster, clique em "`Connect`". 
    - Escolha "Shell" e copie a *connection string* (a string de conex√£o). 
    - Ela ser√° parecida com `mongodb+srv://<username>:<password>@cluster-name...`.

### ‚öôÔ∏è Opera√ß√µes CRUD com MongoDB

Para interagir com seu banco, voc√™ usar√° o **MongoDB Shell (`mongosh`)**. Ao se conectar usando a *connection string* acima, voc√™ cair√° em um terminal interativo.

Vamos imaginar que estamos em um banco de dados chamado `cinemateca`.

Para usar ou criar um banco de dados
```bash
use cinemateca
```

#### ‚úçÔ∏è Create (Inserir Documentos)

  * **`insertOne()`**: Insere um √∫nico documento.
    ```javascript
    db.filmes.insertOne({
      titulo: "Parasita",
      ano_lancamento: 2019,
      genero: ["Suspense", "Com√©dia", "Drama"],
      avaliacao: 9.5
    })
    ```
  * **`insertMany()`**: Insere m√∫ltiplos documentos de uma vez.
    ```javascript
    db.filmes.insertMany([
      { titulo: "A Origem", ano_lancamento: 2010, genero: ["Fic√ß√£o Cient√≠fica", "A√ß√£o"], avaliacao: 9.2 },
      { titulo: "O Poderoso Chef√£o", ano_lancamento: 1972, genero: ["Drama", "Crime"], avaliacao: 9.8 }
    ])
    ```

#### üìñ Read (Consultar Documentos)

  * **`find()`**: Encontra todos os documentos que correspondem a um filtro.
    
    ```javascript
    // Encontrar todos os filmes
    db.filmes.find({})

    // Encontrar filmes lan√ßados depois de 2010
    // $gt = greater than (maior que)
    db.filmes.find({ ano_lancamento: { $gt: 2010 } })

    // Encontrar filmes que sejam do g√™nero "Drama"
    db.filmes.find({ genero: "Drama" })
    ```
  * **`findOne()`**: Retorna apenas o primeiro documento que corresponde ao filtro.
    ```javascript
    db.filmes.findOne({ titulo: "Parasita" })
    ```
  * **Proje√ß√£o**: Selecionar apenas os campos que voc√™ deseja retornar. `1` para incluir, `0` para excluir.
    ```javascript
    // Retornar apenas t√≠tulo e ano de lan√ßamento, excluindo o _id
    db.filmes.find({}, { titulo: 1, ano_lancamento: 1, _id: 0 })
    ```

#### üìù Update (Atualizar Documentos)

√â fundamental usar os **operadores de atualiza√ß√£o** (como `$set`, `$inc`, etc.) para n√£o sobrescrever o documento inteiro.

  * **`updateOne()`**: Atualiza o primeiro documento que corresponde ao filtro.
    ```javascript
    // Usando $set para alterar ou adicionar um campo
    db.filmes.updateOne(
      { titulo: "A Origem" },
      { $set: { avaliacao: 9.3, assistido: true } }
    )

    // Usando $inc para incrementar um valor num√©rico
    db.filmes.updateOne({ titulo: "A Origem" }, { $inc: { avaliacao: 0.1 } }) // agora ser√° 9.4
    ```
  * **`updateMany()`**: Atualiza todos os documentos que correspondem ao filtro.
    ```javascript
    // Adicionar o campo "classico: true" para todos os filmes antes de 1980
    db.filmes.updateMany({ ano_lancamento: { $lt: 1980 } }, { $set: { classico: true } })
    ```

#### üóëÔ∏è Delete (Apagar Documentos)

  * **`deleteOne()`**: Apaga o primeiro documento que corresponde ao filtro.
    ```javascript
    db.filmes.deleteOne({ titulo: "O Poderoso Chef√£o" })
    ```
  * **`deleteMany()`**: Apaga todos os documentos que correspondem ao filtro.
    ```javascript
    // Cuidado! Apaga todos os documentos da cole√ß√£o.
    db.filmes.deleteMany({})
    ```

### ‚ö° Acelerando Consultas com √çndices

Assim como em bancos de dados SQL, √≠ndices s√£o cruciais para a performance de leitura. Se voc√™ frequentemente busca filmes pelo ano, criar um √≠ndice nesse campo tornar√° essas buscas muito mais r√°pidas.

```javascript
// Cria um √≠ndice ascendente (1) no campo ano_lancamento
db.filmes.createIndex({ ano_lancamento: 1 })
```

### üß© Agrega√ß√µes: O Poder de Transformar Dados

O **Aggregation Framework** √© uma das ferramentas mais poderosas do MongoDB. Ele permite que voc√™ processe dados atrav√©s de um "pipeline" (sequ√™ncia de est√°gios), onde o resultado de um est√°gio √© a entrada do pr√≥ximo.

**Exemplo:** Vamos contar quantos filmes temos de cada g√™nero.

```javascript
db.filmes.aggregate([
  // Est√°gio 1: "Desagrupa" o array de g√™neros, criando um documento por g√™nero para cada filme.
  { $unwind: "$genero" },

  // Est√°gio 2: Agrupa os documentos por g√™nero e conta quantos existem em cada grupo.
  { $group: { _id: "$genero", total_filmes: { $sum: 1 } } },

  // Est√°gio 3: Ordena o resultado em ordem alfab√©tica de g√™nero.
  { $sort: { _id: 1 } }
])
```

