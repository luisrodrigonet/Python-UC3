## 12.01.01 : üì¶ Django ORM - Um Guia para Iniciantes

Com este material mergulharemos no mundo da manipula√ß√£o de bancos de dados com Python, de uma forma muito mais simples e intuitiva do que o SQL tradicional.

### üó∫Ô∏è O que √© o Django ORM?

Imagine que voc√™ est√° construindo uma casa. O banco de dados √© a funda√ß√£o, a estrutura que armazena todas as informa√ß√µes importantes. Para interagir com essa funda√ß√£o, voc√™ precisaria, tradicionalmente, de um conjunto de ferramentas complexas e uma linguagem espec√≠fica, o **`SQL`** (`Structured Query Language`).

O **`ORM`** (`Object-Relational Mapper ou Mapeador Objeto-Relacional`) do Django funciona como um arquiteto e um mestre de obras ao mesmo tempo. Ele traduz as suas instru√ß√µes em **Python para o SQL** que o banco de dados entende.

Em termos simples, o Django ORM permite que voc√™:

  * **Crie tabelas** no banco de dados usando **classes em Python** (os famosos *Models*).
  
  * **Consulte, insira, atualize e apague dados** usando **m√©todos e objetos** Python, sem escrever uma √∫nica linha de **`SQL`**(na maioria das vezes).
  
  * **Mude de banco de dados** (de SQLite para PostgreSQL, por exemplo) com o m√≠nimo de altera√ß√£o no seu c√≥digo Python.

Essa abordagem torna o desenvolvimento muito mais r√°pido, menos propenso a erros de sintaxe **`SQL`** e **mais alinhado com o paradigma de programa√ß√£o orientada a objetos**.

### üèóÔ∏è A Base de Tudo: Os Models

Os *`Models`* s√£o o cora√ß√£o do Django `ORM`. Cada `Model` √© **uma classe em Python** que **representa uma tabela** no seu banco de dados. **Os atributos** dessa classe **representam as colunas** da tabela.

Vamos criar um exemplo pr√°tico. Imagine que estamos construindo um sistema para uma biblioteca. Precisaremos de tabelas para `Autor` e `Livro`.

:one: **Definindo os Models:**

No seu arquivo **`models.py`** dentro de uma aplica√ß√£o Django, voc√™ definiria as classes da seguinte forma:

```python
from django.db import models

class Autor(models.Model):
    nome = models.CharField(max_length=100)
    data_nascimento = models.DateField()
    nacionalidade = models.CharField(max_length=50)

    def __str__(self):
        return self.nome

class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    autor = models.ForeignKey(Autor, on_delete=models.CASCADE, related_name='livros')
    ano_publicacao = models.IntegerField()
    isbn = models.CharField(max_length=13, unique=True)

    def __str__(self):
        return self.titulo
```

üîç **Analisando o c√≥digo:**

* **`models.Model`**: 
    - Toda classe de modelo herda de `django.db.models.Model`.
    
* **Campos**: 
    - Cada **atributo** (`nome`, `titulo`, etc.) √© uma **inst√¢ncia de uma classe de campo** do Django (`CharField`, `DateField`, `IntegerField`, `ForeignKey`). 
    - Cada **classe de campo** sabe como se traduzir em um tipo de coluna SQL.
    
* **`ForeignKey`**: 
    - Este √© um campo especial que cria uma **rela√ß√£o** de "**um para muitos**". 
    - Um `Autor` pode ter v√°rios `Livros`, mas cada `Livro` tem apenas um `Autor`.
    
  * **`on_delete=models.CASCADE`**: 
    - Isso significa que se um autor for deletado, todos os seus livros tamb√©m ser√£o.
    
  * **`related_name='livros'`**: 
    - Isso nos permitir√° acessar facilmente todos os livros de um autor (veremos adiante).
    
* **`__str__(self)`**: 
    - √â uma boa pr√°tica definir este m√©todo. 
    - Ele retorna uma representa√ß√£o em string do objeto, o que √© muito √∫til no painel de administra√ß√£o do Django, por exemplo.

:two: **Ativando os Models (Migrations):**

Depois de definir seus modelos, voc√™ precisa dizer ao Django para criar essas tabelas no banco de dados. Isso √© feito em dois passos no terminal:

üîß Cria o arquivo de migra√ß√£o (a "planta baixa" da altera√ß√£o no banco)
```bash
python manage.py makemigrations
```

üîß Aplica a migra√ß√£o, criando as tabelas de fato
```bash 
python manage.py migrate
```

### üß© Tipos de Campos (Fields) e suas Propriedades

A escolha correta dos campos √© fundamental para a integridade e o bom funcionamento do seu banco de dados. Vamos explorar os tipos mais comuns e suas propriedades.

#### Propriedades Comuns a Muitos Campos

Antes de detalhar os tipos, veja algumas **propriedades (ou argumentos)** que podem ser **usadas na maioria** deles:

üéØ **`null=True/False`**: 
- Define se o campo pode ter o valor **`NULL`** no banco de dados. 
- O padr√£o √© `False`.

üéØ **`blank=True/False`**: 
- Relacionado √† valida√ß√£o. 
- Se **`True`**, o campo pode ser deixado em branco em formul√°rios. 
- O padr√£o √© **`False`**. 

üö® **Dica:** `null` √© para o banco de dados, `blank` √© para valida√ß√£o.

üéØ **`default`**: 
- Define um valor padr√£o para o campo. 
- Pode ser um valor literal ou uma fun√ß√£o.

üéØ **`unique=True/False`**: 
- Se **`True`**, garante que todos os valores nesta coluna da tabela sejam √∫nicos.

üéØ **`primary_key=True/False`**: 
- Se **`True`**, define este campo como a chave prim√°ria da tabela

üéØ  **`verbose_name="Nome leg√≠vel"`**: 
- Um nome mais amig√°vel para o campo, usado em formul√°rios e no painel de administra√ß√£o do Django.

üéØ **`help_text="Texto de ajuda"`**: 
- Um texto adicional exibido em formul√°rios para ajudar o usu√°rio.

üéØ **`db_index=True/False`**: 
- Se `True`, cria um √≠ndice de banco de dados para este campo, o que pode acelerar consultas que o utilizam.

üéØ **`editable=False`**: 
- Se **`False`**, o campo n√£o ser√° exibido no painel de administra√ß√£o do Django ou em **`ModelForms`**.

üéØ **`choices`**: 
- Uma lista de tuplas para criar um campo de m√∫ltipla escolha. 
- Ex: `STATUS_CHOICES = [('A', 'Ativo'), ('I', 'Inativo')]`.


#### üî° Campos de Texto

Os principais tipos de campos destinados a armazenamento de texto s√£o:

üó∫Ô∏è **`CharField`**: 
- Para strings de tamanho pequeno a m√©dio.
-  **Propriedade obrigat√≥ria:** **`max_length`**: O n√∫mero m√°ximo de caracteres.
    
üó∫Ô∏è **`TextField`**: 
- Para textos longos, sem limite de tamanho predefinido.

üó∫Ô∏è **`SlugField`**: 
- Um **`CharField`** especial para armazenar "**`slugs`**" (r√≥tulos curtos contendo apenas letras, n√∫meros, underscores ou h√≠fens). 
- Frequentemente usado em URLs. 
- Por padr√£o, j√° tem `db_index=True`.

üìù **Exemplo Pr√°tico:**

```python
from django.db import models

class Artigo(models.Model):
    titulo = models.CharField(
        max_length=200,
        verbose_name="T√≠tulo do Artigo",
        help_text="O t√≠tulo principal que ser√° exibido."
    )
    resumo = models.CharField(
        max_length=255,
        blank=True,
        null=True,
        verbose_name="Resumo (Opcional)"
    )
    conteudo = models.TextField(verbose_name="Conte√∫do Completo")
    slug = models.SlugField(
        unique=True,
        help_text="Identificador √∫nico para a URL do artigo (ex: meu-primeiro-artigo)."
    )

    def __str__(self):
        return self.titulo
```

#### üî¢ Campos Num√©ricos

Os principais tipos de campos destinados a armazenamento de dados num√©ricos s√£o:


üé≤ **`IntegerField`**: Para n√∫meros inteiros.

üé≤ **`PositiveIntegerField`**: Para n√∫meros inteiros positivos.

üé≤ **`FloatField`**: Para n√∫meros de ponto flutuante (n√£o recomendado para valores monet√°rios devido a imprecis√µes).

üé≤ **`DecimalField`**: Para n√∫meros decimais de precis√£o fixa. Ideal para dinheiro e valores financeiros.

  -  **Propriedades obrigat√≥rias:**
      * **`max_digits`**: N√∫mero m√°ximo de d√≠gitos permitidos no n√∫mero (incluindo casas decimais).
      * **`decimal_places`**: N√∫mero de casas decimais a serem armazenadas.

üéØ **Exemplo Pr√°tico:**

```python
class Produto(models.Model):
    nome = models.CharField(max_length=100)
    estoque = models.PositiveIntegerField(default=0, verbose_name="Quantidade em Estoque")
    preco = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        help_text="Pre√ßo de venda. Use '.' como separador decimal."
    )
    peso_kg = models.FloatField(null=True, blank=True, verbose_name="Peso em KG")

    def __str__(self):
        return self.nome
```

#### üìÖ Campos de Data e Hora

Os principais tipos de campos destinados a armazenamento de data e hora s√£o:

‚è∞ **`DateField`**: Para armazenar datas (ano, m√™s, dia).

‚è∞ **`DateTimeField`**: Para armazenar data e hora.

‚è∞ **`TimeField`**: Para armazenar apenas a hora.

 üéÅ **Propriedades √∫teis:**
 
  - **`auto_now_add=True`**: 
    - Salva a data/hora do momento exato em que o objeto √© criado pela primeira vez.
    - N√£o √© mais edit√°vel. 
    - √ìtimo para campos como `data_criacao`.
    
  - **`auto_now=True`**: 
    - Salva a data/hora toda vez que o objeto √© salvo (atualizado). 
    - √ìtimo para campos como `ultima_modificacao`.

üí° **Exemplo Pr√°tico:**

```python
class Evento(models.Model):
    nome = models.CharField(max_length=150)
    data_evento = models.DateField(verbose_name="Data do Evento")
    data_criacao = models.DateTimeField(
        auto_now_add=True,
        verbose_name="Data de Cadastro"
    )
    ultima_modificacao = models.DateTimeField(
        auto_now=True,
        verbose_name="√öltima Modifica√ß√£o"
    )

    def __str__(self):
        return f"{self.nome} em {self.data_evento.strftime('%d/%m/%Y')}"
```

#### üîó Campos de Relacionamento

Estes s√£o os campos mais poderosos, pois criam as rela√ß√µes entre suas tabelas.

üåê **`ForeignKey` (Um-para-Muitos)**: 
- Cria uma rela√ß√£o onde um objeto de um modelo pode estar relacionado a muitos objetos de outro modelo. Ex: Uma `Categoria` tem muitos `Produtos`.

- **Propriedade obrigat√≥ria:** **`on_delete`**: O que fazer quando o objeto "pai" (o "um" da rela√ß√£o) for deletado.
  * **`models.CASCADE`**: Deleta os objetos "filhos" tamb√©m.
  * **`models.PROTECT`**: Impede a dele√ß√£o do pai se ele tiver filhos.
  * **`models.SET_NULL`**: Define a chave estrangeira como **`NULL`**. Exige **`null=True`** no campo.
  * **`models.SET_DEFAULT`**: Define a chave estrangeira para seu valor padr√£o. Exige um `default` no campo.
  
- **Propriedade √∫til:** **`related_name`**: Um nome para acessar os objetos filhos a partir do pai.

üåê **`OneToOneField` (Um-para-Um)**: 
- Cria uma rela√ß√£o exclusiva, onde um objeto s√≥ pode estar ligado a um, e somente um, outro objeto. 
- √â como um `ForeignKey` com `unique=True`. 
- Ex: Um `Usuario` tem um √∫nico `Perfil`.

üåê  **`ManyToManyField` (Muitos-para-Muitos)**: 
- Cria uma rela√ß√£o onde m√∫ltiplos objetos podem estar relacionados a m√∫ltiplos outros objetos. 
- Django cria uma tabela intermedi√°ria para gerenciar essa rela√ß√£o. 
- Ex: Um `Artigo` pode ter v√°rias `Tags`, e uma `Tag` pode estar em v√°rios `Artigos`.

üìö **Exemplo Pr√°tico Combinado:**

```python
class Autor(models.Model):
    nome = models.CharField(max_length=100)

    def __str__(self):
        return self.nome

class PerfilAutor(models.Model):
    autor = models.OneToOneField(Autor, on_delete=models.CASCADE, primary_key=True)
    biografia = models.TextField()

    def __str__(self):
        return f"Perfil de {self.autor.nome}"

class Tag(models.Model):
    nome = models.CharField(max_length=50, unique=True)

    def __str__(self):
        return self.nome

class Livro(models.Model):
    titulo = models.CharField(max_length=200)
    autor = models.ForeignKey(
        Autor,
        on_delete=models.CASCADE,
        related_name='livros' # Acessaremos os livros via autor.livros.all()
    )
    tags = models.ManyToManyField(Tag, blank=True)

    def __str__(self):
        return self.titulo
```

#### üí° Outros Campos √öteis

üéØ **`BooleanField`**: 
- Um campo de verdadeiro/falso. Por padr√£o, armazena `True` ou `False`.

üéØ **`NullBooleanField`**: 
- (Obsoleto a partir do Django 4.1) Armazenava `True`, `False` ou `NULL`.

üéØ **`EmailField`**: 
- Um `CharField` que valida se o valor inserido parece ser um e-mail v√°lido.

üéØ **`URLField`**: 
- Um `CharField` que valida se o valor inserido √© uma URL v√°lida.

üéØ **`UUIDField`**: 
- Para armazenar identificadores √∫nicos universais (UUIDs). 
- √ìtimo para chaves prim√°rias que n√£o devem ser sequenciais ou previs√≠veis.

üéØ **`FileField` / `ImageField`**: 
- Para fazer upload de arquivos ou imagens.
- **Propriedade importante:** **`upload_to`**: 
    - Define o subdiret√≥rio dentro do seu `MEDIA_ROOT` para onde os arquivos ser√£o enviados.
- **`ImageField`** √© um **`FileField`** especial que valida se o arquivo enviado √© uma imagem. Requer a biblioteca **`Pillow`** instalada (`pip install Pillow`).

üìö **Exemplo Pr√°tico:**

```python
import uuid

class DocumentoUsuario(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    usuario_email = models.EmailField(unique=True, verbose_name="E-mail do Usu√°rio")
    foto_perfil = models.ImageField(upload_to='fotos_perfil/', null=True, blank=True)
    ativo = models.BooleanField(default=True)
    site_pessoal = models.URLField(blank=True)

    def __str__(self):
        return self.usuario_email
```


### ‚öôÔ∏è Interagindo com o Banco de Dados (CRUD)

Com o banco criado, podemos realizar as opera√ß√µes b√°sicas de **C**riar, **L**er, **A**tualizar e **D**eletar (**`CRUD - Create, Read, Update, Delete`**) usando apenas Python.

Para testar os comandos a seguir, voc√™ pode usar o **shell interativo** do Django com o comando: 

```bash
python manage.py shell
```

#### ‚úçÔ∏è **Criando Dados (Create)**

Importando os modelos

```python
from minha_app.models import Autor, Livro
```

Adicionado um novo autor
```python
autor1 = Autor.objects.create(
    nome='J.R.R. Tolkien',
    data_nascimento='1892-01-03',
    nacionalidade='Sul-africano'
)
```

Outra forma de criar um autor
```python 
autor2 = Autor(nome='George Orwell', data_nascimento='1903-06-25', nacionalidade='Brit√¢nico')
autor2.save()
```

üåü **Repare:** `Autor.objects` √© o **Manager** do modelo. √â atrav√©s dele que realizamos a maioria das opera√ß√µes no banco de dados.


Criando um livro e associando ao autor
```python 

livro1 = Livro.objects.create(
    titulo='O Hobbit',
    autor=autor1, # <-- Associamos a inst√¢ncia do autor criada anteriormente
    ano_publicacao=1937,
    isbn='9788578277289'
)

livro2 = Livro.objects.create(
    titulo='A Revolu√ß√£o dos Bichos',
    autor=autor2,
    ano_publicacao=1945,
    isbn='9788535914849'
)
```


#### üìñ  **Lendo Dados (Read / Querying)**

Aqui √© onde o poder dos **QuerySets** do Django brilha. Um **QuerySet** √© uma lista de objetos do seu banco de dados.


- Listar todos os autores
    ```python
    todos_os_autores = Autor.objects.all()
    print(todos_os_autores)
    # <QuerySet [<Autor: J.R.R. Tolkien>, <Autor: George Orwell>]>
    ```
- Obter um objeto espec√≠fico pelo **ID (chave prim√°ria)**    
    ```python
    tolkien = Autor.objects.get(id=1)
    print(tolkien.nome)
    # 'J.R.R. Tolkien'
    ```

- Filtrando resultados (equivalente ao WHERE do SQL)
    ```python
    orwell = Autor.objects.filter(nome='George Orwell').first() # <-- .first() pega o primeiro resultado
    print(orwell.nacionalidade)
    # 'Brit√¢nico'
    ```

- Filtros mais complexos    
    ```python
    livros_antigos = Livro.objects.filter(ano_publicacao__lt=1940) # <-- __lt = less than (menor que)
    print(livros_antigos)
    # <QuerySet [<Livro: O Hobbit>]>
    ```

- Ordenando resultados    
    ```python
    autores_ordenados = Autor.objects.order_by('nome')
    print(autores_ordenados)
    # <QuerySet [<Autor: George Orwell>, <Autor: J.R.R. Tolkien>]>
    ```
    
- Acessando dados relacionados   
    ```python
    livros_do_tolkien = tolkien.livros.all() # <-- Usando o related_name que definimos!
    print(livros_do_tolkien)
    # <QuerySet [<Livro: O Hobbit>]>
    ```

**üìù Atualizando Dados (Update)**

1. Primeiro, pegue o objeto que voc√™ quer atualizar
    ```python
    livro_a_atualizar = Livro.objects.get(isbn='9788578277289')
    ```
    
1. Altere o atributo e salve    
    ```python
    livro_a_atualizar.ano_publicacao = 1938
    livro_a_atualizar.save()
    ```

1. Voc√™ tamb√©m pode atualizar v√°rios objetos de uma vez    
    ```python
    Autor.objects.filter(nacionalidade='Brit√¢nico').update(nacionalidade='Ingl√™s')
    ```

**üóëÔ∏è Deletando Dados (Delete)**

- Pegue o objeto e chame o m√©todo delete()
```python
autor_a_deletar = Autor.objects.get(nome='George Orwell')
autor_a_deletar.delete()
```

Isso ir√° deletar o autor e, por causa do **`on_delete=models.CASCADE`**, todos os livros associados a ele tamb√©m ser√£o deletados.

### üîç Dicas e Consultas Avan√ßadas

O **`ORM`** vai muito al√©m do **`CRUD`** b√°sico. Aqui est√£o alguns exemplos do que mais voc√™ pode fazer:

  * **`_ _icontains`**: Para buscas de texto que n√£o diferenciam mai√∫sculas de min√∫sculas.
    ```python
    Livro.objects.filter(titulo_ _icontains='hobbit')
    ```
    
  * **`exclude`**: Para obter todos os objetos, exceto alguns.
    ```python
    Autor.objects.exclude(nacionalidade='Sul-africano')
    ```
    
  * **Agrega√ß√µes (`Avg`, `Sum`, `Count`)**: Para realizar c√°lculos nos seus dados.
    
    Importando as fun√ß√µes
    ```python
    from django.db.models import Avg, Count
    ```
    
    Contar quantos livros cada autor tem
    ```python
    autores_com_contagem = Autor.objects.annotate(num_livros=Count('livros'))
    for autor in autores_com_contagem:
        print(f'{autor.nome} tem {autor.num_livros} livro(s)')
    ```
    
    Calcular a m√©dia de ano de publica√ß√£o
    ```
    media_ano = Livro.objects.all().aggregate(Avg('ano_publicacao'))
    print(media_ano)
    ```

Este tutorial cobre os fundamentos essenciais do Django ORM. Dominar essas ferramentas abrir√° um mundo de possibilidades para seus projetos Django, permitindo que voc√™ construa aplica√ß√µes complexas com um c√≥digo limpo, leg√≠vel e eficiente.