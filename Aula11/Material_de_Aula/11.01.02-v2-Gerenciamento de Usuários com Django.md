## 11.01.02 : Gerenciamento de Usu√°rios com Django

Este material dedica-se a explicar como definir usu√°rios e implementar um *backend* de autentica√ß√£o e autoriza√ß√£o com Django 5.2, HTML 5 e Bootstrap 5.3.

Exploraremos como criar e gerenciar usu√°rios em projetos Django, garantindo que apenas pessoas autorizadas possam acessar determinadas informa√ß√µes ou funcionalidades. 

Usaremos os modelos de usu√°rio do pr√≥prio Django, que facilitam muito esse processo.

### :one: Conceito de Usu√°rios e Autentica√ß√£o

Imagine uma loja f√≠sica. Nem todo mundo pode ir ao estoque e pegar os produtos, certo? Apenas os funcion√°rios autorizados. Na web, √© a mesma coisa. Queremos que apenas usu√°rios "**autenticados**" (que provaram ser quem dizem ser, geralmente com login e senha) tenham acesso a certas √°reas ou a√ß√µes.

  * **Autentica√ß√£o**: √â o processo de **verificar a identidade** de um usu√°rio. Quando voc√™ faz login com seu nome de usu√°rio e senha, o sistema est√° te autenticando.
  
  * **Autoriza√ß√£o**: Uma vez autenticado, a autoriza√ß√£o **determina o que** o usu√°rio **pode ou n√£o fazer.** Um gerente pode ter acesso a todas as informa√ß√µes de produtos, enquanto um vendedor pode apenas visualizar.

O Django j√° vem com um sistema de autentica√ß√£o e autoriza√ß√£o robusto e pronto para usar, o que nos poupa muito trabalho\!

### :two: Configurando o Projeto Django para Usu√°rios

Seu projeto `core` j√° deve estar configurado. Vamos garantir que as configura√ß√µes de autentica√ß√£o do Django estejam ativas.

#### üìö Verificando `INSTALLED_APPS`

Abra o arquivo **`settings.py`** dentro da pasta **`core`** (ou onde estiver seu arquivo de configura√ß√µes principal) e certifique-se de que as seguintes aplica√ß√µes estejam listadas em **`INSTALLED_APPS`**:

```python
# core/settings.py

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',  # <-- Essencial para autentica√ß√£o (Aula 11.01.02)
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'produtos',
    'site_loja',
    # ... outras apps que voc√™ possa ter
]
```

As aplica√ß√µes **`django.contrib.auth`**, **`django.contrib.contenttypes`**, **`django.contrib.sessions`** e **`django.contrib.messages`** s√£o as que fornecem toda a infraestrutura para o sistema de usu√°rios.

#### üìö  Executando as Migra√ß√µes

Sempre que voc√™ adiciona ou altera aplicativos que lidam com banco de dados, √© preciso "**informar**" ao Django para criar as tabelas necess√°rias no seu banco de dados.

Abra seu terminal na raiz do projeto (**`core`**) e execute os seguintes comandos:

```bash
python manage.py makemigrations
python manage.py migrate
```

O comando **`migrate`** vai criar as tabelas para os modelos de usu√°rio, grupos e permiss√µes, entre outras.

### :three: Criando um Superusu√°rio (Administrador)

Para gerenciar os usu√°rios e outras informa√ß√µes do seu ***backend***, voc√™ precisar√° de um **superusu√°rio**. Um superusu√°rio tem todas as permiss√µes e pode acessar o painel de administra√ß√£o do Django.

No terminal, execute:

```bash
python manage.py createsuperuser
```

O Django vai te pedir um **nome** de usu√°rio, um endere√ßo de **e-mail** (opcional) e uma **senha**. Digite a senha duas vezes para confirmar.

### :four: Acessando o Painel de Administra√ß√£o do Django

Agora que voc√™ tem um superusu√°rio, vamos acessar o painel de administra√ß√£o.

1. Inicie o servidor de desenvolvimento do Django:

    ```bash
    python manage.py runserver
    ```

1. Abra seu navegador e v√° para http://127.0.0.1:8000/admin/.

1. Use o nome de usu√°rio e a senha que voc√™ criou com o `createsuperuser`.

Voc√™ ver√° o painel de administra√ß√£o do Django. Note que j√° existem se√ß√µes para "**Usu√°rios**" e "**Grupos**" (**`Users`** e **`Groups`**). √â por aqui que voc√™ pode criar, editar e gerenciar seus usu√°rios.

### :five: Criando P√°ginas de **`Login`** e **`Logout`**

Para que seus usu√°rios possam acessar as √°reas restritas, eles precisam ter como fazer **login** e **logout**. Vamos criar as **URLs**, ***views*** e **templates** para isso.

#### üß∞ URLs de Autentica√ß√£o

O Django j√° oferece ***views*** prontas para **login** e **logout**. Basta configur√°-las nas URLs.

Atualize o  arquivo `urls.py` dentro da sua aplica√ß√£o `site_loja` se ainda n√£o tiver um, ou adicione as URLs existentes:

```python
# site_loja/urls.py

from django.urls import path
from django.contrib.auth import views as auth_views # <-- Importa as views de autentica√ß√£o do Django (Aula 11.01.02)

urlpatterns = [
    # ... outras URLs da sua aplica√ß√£o site_loja
    path('login/', auth_views.LoginView.as_view(template_name='site_loja/login.html'), name='login'),
    path('logout/', auth_views.LogoutView.as_view(next_page='site/'), name='logout'), # Redireciona para a home ap√≥s o logout (Aula 11.01.02)
]
```

#### üß∞ Criando o Template de Login (**`login.html`**)

Dentro da pasta **`site_loja/templates/site_loja/`**, crie um arquivo chamado **`login.html`**. Usaremos o Bootstrap 5.3 para um design responsivo e bonito.

```html
{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Minha Loja</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="card p-4 shadow-sm" style="max-width: 400px; width: 100%;">
            <h2 class="card-title text-center mb-4">Login</h2>
            <form method="post">
                {% csrf_token %} {# Tag obrigat√≥ria para seguran√ßa em formul√°rios Django #}
                {% if form.errors %}
                    <div class="alert alert-danger" role="alert">
                        Usu√°rio ou senha inv√°lidos. Tente novamente.
                    </div>
                {% endif %}
                <div class="mb-3">
                    <label for="{{ form.username.id_for_label }}" class="form-label">Nome de Usu√°rio:</label>
                    {{ form.username }}
                    {% if form.username.errors %}
                        <div class="text-danger small mt-1">{{ form.username.errors }}</div>
                    {% endif %}
                </div>
                <div class="mb-3">
                    <label for="{{ form.password.id_for_label }}" class="form-label">Senha:</label>
                    {{ form.password }}
                    {% if form.password.errors %}
                        <div class="text-danger small mt-1">{{ form.password.errors }}</div>
                    {% endif %}
                </div>
                <button type="submit" class="btn btn-primary w-100">Entrar</button>
            </form>
            <p class="text-center mt-3 mb-0">
                <a href="#">Esqueceu a senha?</a> {# Voc√™ pode implementar uma recupera√ß√£o de senha futuramente #}
            </p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
```

‚ö†Ô∏è **Observa√ß√µes importantes sobre o `login.html`:**

  * `{% csrf_token %}`: 
      * √â uma medida de seguran√ßa do Django contra ataques CSRF (Cross-Site Request Forgery). 
      * Sempre use em formul√°rios `POST`.
      
  * `{{ form.username }}` e `{{ form.password }}`: 
      * Estas s√£o vari√°veis que a *view* de login do Django (`LoginView`) automaticamente passa para o template. 
      * Elas representam os campos de entrada HTML para nome de usu√°rio e senha.
      
  * `{% if form.errors %}`: 
      * Verifica se houve erros no formul√°rio (por exemplo, nome de usu√°rio ou senha incorretos) e exibe uma mensagem.

#### üß∞ Adicionando Links de Login/Logout na Navega√ß√£o

Vamos adicionar **links** de **login** e **logout** no seu template base ou em alguma parte do seu site, para que os usu√°rios possam interagir com eles.

Assumindo que voc√™ tem um `site_loja\templates\site_loja\partials\_navbar.html`, ajuste o seu conte√∫do para:

```html
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'site_loja:home' %}">Minha Loja</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="{% url 'site_loja:home' %}">In√≠cio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'site_loja:produtos_lista' %}">Produtos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Contato</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Categorias
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="#">Eletr√¥nicos</a></li>
                        <li><a class="dropdown-item" href="#">Moda</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#">Todos os Produtos</a></li>
                    </ul>
                </li>
            </ul>
             
            <form class="d-flex" role="search">
                <input class="form-control me-2" type="search" placeholder="Buscar" aria-label="Search">
                <button class="btn btn-outline-light" type="submit">Buscar</button>
            </form>

            <!-- Aula 10 -->
            <ul class="navbar-nav">
                {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'site_loja:perfil' %}">Perfil ({{ user.username }})</a>
                    </li>
                    <li class="nav-item">
                        <form action="{% url 'site_loja:logout' %}" method="post" style="display: inline;">
                            {% csrf_token %} {# ESSENCIAL para seguran√ßa #}
                            <button type="submit" 
                                class="nav-link btn btn-link" >
                                Sair
                            </button>
                        </form>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'site_loja:login' %}">Entrar</a>
                    </li>  
                {% endif %}
            </ul>
            <!-- Aula 10 -->
            
        </div>
    </div>
</nav>
```

**Explica√ß√£o:**

  * `{% if user.is_authenticated %}`: 
      * Esta √© uma tag de template do Django que verifica se o usu√°rio atual est√° logado. 
      * Se sim, exibe o nome de usu√°rio e um link para sair.
      
  * `{% else %}`: 
      * Se o usu√°rio n√£o estiver logado, exibe um link para entrar.
      *
  * `{{ user.username }}`: 
      * A vari√°vel `user` √© automaticamente dispon√≠vel nos templates quando `django.contrib.auth` est√° configurado. 
      * Ela representa o objeto do usu√°rio logado.

### :six: Protegendo Suas Views (Requisi√ß√£o de Login)

Agora que temos as p√°ginas de **login**, vamos garantir que certas p√°ginas s√≥ possam ser acessadas por usu√°rios logados.

#### üß± Usando o Decorador `@login_required`

Para proteger uma *view* (fun√ß√£o ou classe) de forma simples, podemos usar o decorador **`@login_required`**.

Abra o arquivo **`views.py`** da sua aplica√ß√£o **`produtos`** (ou da aplica√ß√£o que voc√™ quer proteger).

```python
# produtos/views.py

from django.shortcuts import render
from django.contrib.auth.decorators import login_required # <-- Importa o decorador (Aula 11)

@login_required(login_url='/site/login/') # <-- Redireciona para a URL de login se o usu√°rio n√£o estiver logado (Aula 11)
def index(request):
    """
    Esta fun√ß√£o √© a nossa view 'index'.
    Ela ser√° respons√°vel por exibir a p√°gina inicial da aplica√ß√£o produtos.
    """
    
    # Criamos um dicion√°rio com dados que queremos enviar para o template.
    # Por enquanto, vamos enviar um t√≠tulo simples.
    context = {
        'titulo': 'Bem-vindo √† P√°gina de Produtos!'
    }

    # A fun√ß√£o render 'junta' o template com os dados e retorna uma resposta HTTP.
    return render(request, 'produtos/index_static.html', context)
```

**Explica√ß√£o:**

  * `@login_required(login_url='/login/')`: 
      * Quando esta *view* √© acessada, o Django verifica se o usu√°rio est√° autenticado. 
      * Se n√£o estiver, ele o redireciona para a URL especificada em `login_url` (neste caso, `'/login/'`).
      * 
  * Voc√™ precisar√° criar os templates `lista_produtos.html` e `detalhe_produto.html` em `produtos/templates/produtos/` para que essas *views* funcionem.

#### üß±  Protegendo Views Baseadas em Classe (`MethodView`)

Se voc√™ estiver usando *views* baseadas em classe, use `LoginRequiredMixin`:

```python
# produtos/views.py (Exemplo com classe)

from django.views.generic import ListView, DetailView
from django.contrib.auth.mixins import LoginRequiredMixin # Importa o mixin

class ProdutoListView(LoginRequiredMixin, ListView):
    model = Produto # Supondo que voc√™ tenha um modelo Produto
    template_name = 'produtos/lista_produtos.html'
    context_object_name = 'produtos'
    login_url = '/login/' # Onde redirecionar se n√£o estiver logado

class ProdutoDetailView(LoginRequiredMixin, DetailView):
    model = Produto
    template_name = 'produtos/detalhe_produto.html'
    context_object_name = 'produto'
    pk_url_kwarg = 'id' # Para o ID do produto na URL
    login_url = '/login/'
```

‚ö†Ô∏è **Lembre-se** de ajustar suas URLs para apontar para as *views* corretas se voc√™ mudar de fun√ß√£o para classe.


### :seven: Protegendo Informa√ß√µes Sens√≠veis (Autoriza√ß√£o por Permiss√µes e Grupos)

Al√©m de saber *quem* √© o usu√°rio, queremos saber *o que* ele pode fazer.

#### üß± Permiss√µes

O Django cria permiss√µes automaticamente para os modelos que voc√™ define (por exemplo, `can_add_produto`, `can_change_produto`, `can_delete_produto`, `can_view_produto`). Voc√™ pode atribuir essas permiss√µes a usu√°rios individuais ou, o que √© mais comum e organizado, a **grupos**.

#### üß± Grupos

Imagine que voc√™ tem diferentes tipos de funcion√°rios: "Gerentes" e "Vendedores".

1. **Crie Grupos no Painel de Administra√ß√£o:**

      * V√° para `http://127.0.0.1:8000/admin/`.
     
      * Na se√ß√£o `AUTH ET AUTORISATION`, clique em  `+ Add` ao lado de  `Groups`.
     
      * Crie um grupo chamado "**Gerentes**" e adicione as permiss√µes que um gerente deve ter (por exemplo, todas as permiss√µes para o modelo `Produto`).
      
      * Crie outro grupo chamado "**Vendedores**" e adicione as permiss√µes que um vendedor deve ter (por exemplo, `can_view_produto` e `can_add_produto`).

1. **Atribua Usu√°rios aos Grupos:**

      * No painel de administra√ß√£o, v√° para a se√ß√£o `Usu√°rios` (ou `Users`).
     
      * Clique em um usu√°rio existente ou crie um novo.
     
      * Role para baixo at√© a se√ß√£o `Grupos` (ou `Groups`) e adicione o usu√°rio ao grupo apropriado.

#### üß± Protegendo Views por Permiss√£o

Voc√™ pode usar os decoradores **`@permission_required`** ou **`PermissionRequiredMixin`** para proteger *views* com base nas permiss√µes do usu√°rio.

```python
# produtos/views.py

from django.shortcuts import render
from django.contrib.auth.decorators import permission_required # <-- Importa o decorador
from django.contrib.auth.mixins import PermissionRequiredMixin # <-- Para classes

@permission_required('produtos.view_produto', login_url='/login/') # Requer permiss√£o para visualizar produtos
def lista_produtos(request):
    produtos = [
        {'nome': 'Camiseta', 'preco': 59.90},
        {'nome': 'Cal√ßa Jeans', 'preco': 129.90},
    ]
    return render(request, 'produtos/lista_produtos.html', {'produtos': produtos})

@permission_required('produtos.add_produto', login_url='/login/') # Requer permiss√£o para adicionar produtos
def adicionar_produto(request):
    # L√≥gica para adicionar um produto
    return render(request, 'produtos/adicionar_produto.html')

# Exemplo com classe
class ProdutoCreateView(PermissionRequiredMixin, CreateView):
    model = Produto
    template_name = 'produtos/adicionar_produto.html'
    fields = ['nome', 'preco'] # Campos do formul√°rio
    permission_required = 'produtos.add_produto'
    login_url = '/login/'
```

üåü **Formato da permiss√£o:** `app_name.action_model_name` (ex: `produtos.view_produto`).

#### üß± Protegendo Conte√∫do em Templates (Permiss√µes)

Voc√™ tamb√©m pode exibir ou ocultar partes de um template com base nas permiss√µes do usu√°rio logado:

```html
<h2>Lista de Produtos</h2>

{% if perms.produtos.add_produto %} {# Verifica se o usu√°rio tem permiss√£o para adicionar produtos #}
    <a href="{% url 'adicionar_produto' %}" class="btn btn-success mb-3">Adicionar Novo Produto</a>
{% endif %}

<table class="table">
    <thead>
        <tr>
            <th>Nome</th>
            <th>Pre√ßo</th>
            <th>A√ß√µes</th>
        </tr>
    </thead>
    <tbody>
        {% for produto in produtos %}
        <tr>
            <td>{{ produto.nome }}</td>
            <td>R$ {{ produto.preco|floatformat:2 }}</td>
            <td>
                {% if perms.produtos.change_produto %}
                    <a href="{% url 'editar_produto' produto.id %}" class="btn btn-sm btn-warning">Editar</a>
                {% endif %}
                {% if perms.produtos.delete_produto %}
                    <a href="{% url 'excluir_produto' produto.id %}" class="btn btn-sm btn-danger">Excluir</a>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="3">Nenhum produto cadastrado.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
```

üéØ **Explica√ß√£o:**

  * `{% if perms.app_name.permission_name %}`: 
      * Esta tag verifica se o usu√°rio logado possui a permiss√£o especificada para a aplica√ß√£o e a√ß√£o. Se sim, o conte√∫do dentro do `if` √© exibido.

