# 11.02.03 : üì¶ Django e MongoDB Atlas

Neste guia conectaremos um projeto Django ao MongoDB Atlas de uma forma clara e did√°tica, perfeita para quem est√° come√ßando.

O guia foi pensado para o seu projeto `core`, levando em conta as aplica√ß√µes `produtos` e `site_loja`.

### üó∫Ô∏è Roteiro da atividade

Vamos seguir estes passos para garantir que tudo funcione perfeitamente:

1.  **Entendendo a Conex√£o:** O que √© o MongoDB Atlas e por que precisamos de um "tradutor" como o `djongo`.

2.  **Configurando o MongoDB Atlas:** Criaremos sua conta, um cluster gratuito e um usu√°rio para o banco de dados.

3.  **Preparando o Projeto Django:** Instalaremos as bibliotecas necess√°rias e configuraremos as vari√°veis de ambiente de forma segura.

4.  **Conectando o Django ao Atlas:** Alteraremos o arquivo `settings.py` para apontar para nosso novo banco de dados na nuvem.

5.  **Testando e Migrando:** Executaremos os comandos para garantir que a conex√£o foi um sucesso e criaremos as estruturas no MongoDB.

6.  **Adaptando seus Models:** Um exemplo pr√°tico com a sua app `produtos`.

### üéØ Passo 0: Entendendo a Conex√£o

O Django foi originalmente constru√≠do para trabalhar com bancos de dados relacionais (**`SQL`**), como **PostgreSQL** ou **SQLite**. O MongoDB, por outro lado, √© um banco de dados n√£o-relacional (**`NoSQL`**), que armazena dados em um formato semelhante a **`JSON`** chamado **`BSON`**.

Para fazer essa "tradu√ß√£o" entre o que o Django espera (tabelas, linhas, colunas) e como o MongoDB funciona (cole√ß√µes, documentos, campos), usamos um conector. O mais popular para essa tarefa √© o **Djongo**.

**Em resumo:**

  * **Django:** Nosso framework web.
  * **MongoDB Atlas:** Nosso banco de dados na nuvem.
  * **Djongo:** A "ponte" que permite que o Django converse com o MongoDB.

### ‚òÅÔ∏è Passo 1: Configurando o MongoDB Atlas

Primeiro, precisamos **criar nosso banco de dados na nuvem**.

:one:  **Crie uma Conta:** Acesse o site do [MongoDB Atlas](https://www.mongodb.com/cloud/atlas/register) e crie uma conta gratuita.

:two:  **Crie um Novo Projeto:** Ap√≥s o login, voc√™ ser√° guiado para criar uma organiza√ß√£o e um projeto. D√™ um nome ao seu projeto, como `Loja Core`.

:three:  **Crie um Cluster Gratuito (M0):**

1. Clique em "Build a Database".

1. Escolha a op√ß√£o **Shared (M0)**, que √© gratuita e perfeita para aprendizado e desenvolvimento.

1. Voc√™ pode manter as configura√ß√µes padr√£o do provedor de nuvem (AWS, Google Cloud, etc.) e da regi√£o.

1. No final da p√°gina, d√™ um nome ao seu cluster, por exemplo, `cluster-loja`. Clique em "Create".

:four:  **Crie um Usu√°rio do Banco de Dados:**

1. Enquanto o cluster est√° sendo criado, v√° para a se√ß√£o **Database Access** no menu √† esquerda.

1. Clique em "Add New Database User".

1. Escolha um m√©todo de autentica√ß√£o. O mais simples √© **Password**.

1. Digite um nome de usu√°rio (ex: `django_user`) e uma senha. **Anote essa senha em um local seguro\!** Voc√™ precisar√° dela em breve.

1. Em "Database User Privileges", selecione "Read and write to any database".

1. Clique em "Add User".

:five: **Configure o Acesso de Rede (IP):**

1. V√° para a se√ß√£o **Network Access** no menu √† esquerda.

1. Clique em "Add IP Address".

1. Para fins de desenvolvimento e para facilitar, clique em **"ALLOW ACCESS FROM ANYWHERE"**. Isso adicionar√° o endere√ßo `0.0.0.0/0`.

1. Clique em "Confirm".

üö® **Aten√ß√£o:** Em um ambiente de produ√ß√£o real, voc√™ deve restringir o acesso apenas aos IPs do seu servidor. Para aprender, esta op√ß√£o √© a mais f√°cil.

:six:  **Obtenha a String de Conex√£o:**

1. Volte para a vis√£o geral do seu **Database** e, quando o cluster estiver pronto, clique em **"Connect"**.

1. Selecione a op√ß√£o **"Drivers"** (pode aparecer como "Connect your application").

1. Em "Driver", selecione **Python** e a vers√£o mais recente.

1. Copie a **Connection String** que aparece. Ela ser√° algo como:

```python
mongodb+srv://<username>:<password>@cluster-loja.xxxxx.mongodb.net/?retryWrites=true&w=majority
```

üéâ Pronto. A parte do MongoDB Atlas est√° configurada.


### üêç Passo 2: Preparando o Projeto Django

Agora, vamos preparar nosso ambiente Python para se conectar ao Atlas.

:one:  **Instale as Bibliotecas Necess√°rias:**

- Abra o terminal com seu ambiente virtual ativado e instale o **`djongo`** e o **`python-dotenv`** (para gerenciar nossas credenciais de forma segura).

    ```bash
    pip install djongo
    pip install python-dotenv
    ```

:two: **Crie um Arquivo de Vari√°veis de Ambiente (`.env`):**

- Na raiz do seu projeto **`core`** (na mesma pasta onde est√° o **`manage.py`**), crie um arquivo chamado **`.env`**. √â aqui que guardaremos nossa string de conex√£o secreta.

- Dentro do arquivo `.env`, adicione a string de conex√£o que voc√™ copiou do Atlas.

    ```ini
    # .env
    MONGO_DB_URL=mongodb+srv://django_user:SUA_SENHA_AQUI@cluster-loja.xxxxx.mongodb.net/?retryWrites=true&w=majority
    ```

üö® **Importante:** Substitua **`django_user`** pelo seu usu√°rio (se for diferente) e **`SUA_SENHA_AQUI`** pela senha que voc√™ criou no Passo 1.

:three: **Ignore o Arquivo `.env` no Git:**

- √â crucial que este arquivo nunca seja enviado para o seu reposit√≥rio (como o GitHub). Abra o arquivo `.gitignore` (que tamb√©m fica na raiz do projeto) e adicione uma nova linha:

    ```text
    # .gitignore

    # ... outras linhas
    .env
    ```

### ‚öôÔ∏è Passo 3: Conectando o Django ao Atlas

√â hora de dizer ao Django para usar nosso novo banco de dados.

:one:  **Edite o `settings.py`:**
    
- V√° para a pasta do seu projeto principal (**`core/core/`**) e abra o arquivo **`settings.py`**.

:two: **Importe as Bibliotecas:**

No topo do arquivo, adicione as importa√ß√µes para **`pathlib`** (que o Django j√° usa) e **`os`** para carregar nossas vari√°veis de ambiente com a ajuda do **`dotenv`**.

    ```python
    # core/core/settings.py

    from pathlib import Path        # <-- Verifique esta linha
    import os                       # <-- Verifique esta linha
    from dotenv import load_dotenv  # <-- Adicione esta linha

    load_dotenv()                   # <-- Adicione esta linha para carregar as vari√°veis do .env
    ```

:three:  **Configure a Vari√°vel `DATABASES`:**

- Procure pela vari√°vel **`DATABASES`**. Originalmente, ela se parece com isto:

    ```python
    # Configura√ß√£o original com SQLite
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.sqlite3',
            'NAME': BASE_DIR / 'db.sqlite3',
        }
    }
    ```

    Agora, vamos **substitu√≠-la** pela configura√ß√£o do MongoDB:

    ```python
    # core/core/settings.py

    # Nova configura√ß√£o para o MongoDB Atlas
    DATABASES = {
        'default': {
            'ENGINE': 'djongo',         # <-- Usando o motor do djongo
            'NAME': 'db_loja',          # <-- Nome do banco de dados que ser√° criado no Atlas
            'ENFORCE_SCHEMA': False,    # <-- O MongoDB n√£o tem um esquema r√≠gido
            'CLIENT': {
                'host': os.getenv('MONGO_DB_URL') # <-- Puxando a string de conex√£o do .env
            }
        }
    }
    ```

üß∞ **Explica√ß√£o dos campos:**

  * **`ENGINE`**: Informa ao Django para usar o **`djongo`** como tradutor.
  
  * **`NAME`**: O nome que seu banco de dados ter√° dentro do cluster do Atlas. Voc√™ pode escolher qualquer nome, como **`db_loja`**.
  
  * **`ENFORCE_SCHEMA`: `False`** porque o MongoDB √© "**schemaless**", ou seja, mais flex√≠vel que o SQL.
  
  * **`CLIENT`**: Um dicion√°rio que cont√©m a **`host`**, que √© a nossa string de conex√£o segura, carregada do arquivo **`.env`**.

### ‚úÖ Passo 4: Testando e Migrando

Vamos verificar se tudo deu certo.

:one:   **Execute as Migra√ß√µes:**

- No terminal, execute o comando **`migrate`**. Este comando ler√° todos os modelos do seu projeto (incluindo os de autentica√ß√£o do Django, da sua app `produtos`, etc.) e criar√° as "cole√ß√µes" correspondentes no MongoDB.

    ```bash
    python manage.py migrate
    ```

:two:  **Verifique o Resultado:**

* **No Terminal:** Se o comando for executado sem erros vermelhos e mostrar v√°rias linhas com "Applying..." e "OK", √© um √≥timo sinal.

* **No MongoDB Atlas:** Volte ao seu dashboard do Atlas. Clique em **"Browse Collections"**. Voc√™ dever√° ver um novo banco de dados chamado `db_loja` (ou o nome que voc√™ escolheu) e dentro dele v√°rias cole√ß√µes, como `auth_user`, `django_migrations`, etc.

Se voc√™ viu as cole√ß√µes no Atlas, **parab√©ns\! Voc√™ conectou com sucesso o Django ao MongoDB.**

### üì¶ Passo 5: Exemplo Pr√°tico com a App **`produtos`**

O **`djongo`** faz um √≥timo trabalho ao traduzir os modelos do Django. Voc√™ pode continuar escrevendo seus modelos de forma muito parecida com o que faria para um banco SQL.

Vamos imaginar um modelo simples na sua aplica√ß√£o **`produtos`**.

Abra o arquivo **`produtos/models.py`** e adicione o seguinte c√≥digo:

```python
# produtos/models.py

from django.db import models

class Categoria(models.Model):
    nome = models.CharField(max_length=100, unique=True)
    slug = models.SlugField(max_length=100, unique=True)

    def __str__(self):
        return self.nome

class Produto(models.Model):
    nome = models.CharField(max_length=200)
    descricao = models.TextField()
    preco = models.DecimalField(max_digits=10, decimal_places=2)
    categoria = models.ForeignKey(Categoria, on_delete=models.CASCADE, related_name='produtos')
    disponivel = models.BooleanField(default=True)
    criado_em = models.DateTimeField(auto_now_add=True)
    atualizado_em = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.nome
```

üß≠ **O que acontece aqui?**

  * Este c√≥digo √© **id√™ntico** ao que voc√™ usaria com SQLite ou PostgreSQL.
  
  * O `djongo` ir√° inteligentemente converter o `ForeignKey` em um campo de refer√™ncia no documento do `Produto` dentro do MongoDB.

Para aplicar esses novos modelos, execute:

```bash
python manage.py makemigrations produtos
python manage.py migrate
```

Agora, ao verificar suas cole√ß√µes no Atlas, voc√™ ver√° **`produtos_categoria`** e **`produtos_produto`**. 

Voc√™ pode at√© usar o Admin do Django para adicionar categorias e produtos, e eles ser√£o salvos diretamente na nuvem do MongoDB.

### ‚ú® Conclus√£o

Voc√™ acaba de realizar uma tarefa de n√≠vel profissional: conectar um projeto Django a um banco de dados NoSQL moderno na nuvem. Voc√™ aprendeu a:

  * Configurar um ambiente seguro no MongoDB Atlas.
  * Proteger suas credenciais usando vari√°veis de ambiente.
  * Configurar o Django para usar um banco de dados n√£o-relacional com `djongo`.
  * Verificar a conex√£o e entender como os modelos do Django se traduzem em cole√ß√µes no MongoDB.

A partir daqui, o desenvolvimento do seu site na app `site_loja` e o gerenciamento na app `produtos` podem continuar normalmente, mas agora com a flexibilidade e escalabilidade do MongoDB.
