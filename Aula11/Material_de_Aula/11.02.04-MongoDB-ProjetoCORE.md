# 11.02.04 : üöÄ Django e o MongoDB - Projeto Core

Conectar seu projeto Django ao MongoDB Atlas √© um excelente passo para trabalhar com um banco de dados NoSQL robusto e escal√°vel na nuvem.

Como o Django n√£o tem suporte nativo para MongoDB, usaremos um pacote chamado **`djongo`**, que faz a "tradu√ß√£o" entre o ORM do Django e o MongoDB.

### üåê Conectando seu Projeto Django ao MongoDB Atlas

Este guia assume que voc√™ j√° tem seu projeto Django `core` criado. O processo √© focado na configura√ß√£o, ent√£o seus modelos em `productos` e `site` funcionar√£o da mesma forma.

#### Passo 1: üß∞ Preparando o Terreno no MongoDB Atlas

Antes de mexer no c√≥digo, precisamos criar nosso banco de dados na nuvem.

:one:  **Crie uma Conta no MongoDB Atlas:**

- Acesse o site do [MongoDB Atlas](https://www.mongodb.com/cloud/atlas) e **crie uma conta gratuita**.

:two: **Crie um Novo Projeto:**

- Ap√≥s o login, voc√™ ser√° guiado para **criar uma organiza√ß√£o** e, dentro dela, **um projeto**. D√™ um nome ao seu projeto, como "**`Loja Django`**".

:three: **Crie um Cluster (Build a Database):**

* Clique em "**Build a Database**".

* Escolha o plano gratuito **M0 (Shared)**. Ele √© mais que suficiente para come√ßar.

* **Escolha um provedor** de nuvem e uma regi√£o (pode deixar o padr√£o, geralmente o mais pr√≥ximo de voc√™).

* Clique em **"Create"**. A cria√ß√£o do cluster pode levar alguns minutos.

:four: **Crie um Usu√°rio para o Banco de Dados:**

* Enquanto o cluster √© criado, v√° para o menu √† esquerda, em "**Security" -\> "Database Access**".

* Clique em **"Add New Database User"**.

* Escolha um m√©todo de autentica√ß√£o (recomendo **Password**).

* Defina um **nome de usu√°rio** (ex: `django_user`) e uma **senha forte**. Anote essa senha, pois voc√™ precisar√° dela.

* Em "**Database User Privileges**", selecione **"Read and write to any database"** para simplificar.

* Clique em "**Add User**".

:five:   **Libere o Acesso (IP Whitelist):**

* Ainda em "**Security**", v√° para "**Network Access**".

* Clique em **"Add IP Address"**.

* Para desenvolvimento, a forma mais f√°cil √© clicar em **"Allow Access From Anywhere"**. Isso liberar√° o acesso de qualquer IP (**0.0.0.0/0**).

* Clique em "**Confirm**".


üö® **Aten√ß√£o:** Para um ambiente de produ√ß√£o real, o **ideal √© adicionar apenas os IPs** dos seus servidores.

#### Passo 2: üîë Obtendo a String de Conex√£o

Essa string √© a "chave" que seu projeto Django usar√° **para encontrar e se autenticar** no seu banco de dados na nuvem.

1.  Volte para a tela principal do seu cluster (em "**Data Services" -\> "Databases**").

2.  Clique no bot√£o **"Connect"** do seu cluster.

3.  Selecione a op√ß√£o **"Drivers"**.

4.  Voc√™ ver√° um c√≥digo com uma **string de conex√£o**. Copie essa string\! Ela ser√° parecida com isto:

```
mongodb+srv://<username>:<password>@cluster0.xxxxx.mongodb.net/?retryWrites=true&w=majority
```

#### Passo 3: üì¶ Instalando o `djongo`

Agora, no ambiente virtual do seu projeto Django, instale o pacote **`djongo`**:

```bash
pip install djongo
```

#### Passo 4: ‚öôÔ∏è Configurando o `**core/settings.py`**

Esta √© a parte principal. Vamos dizer ao Django para usar o **`djongo`** e apontar para o nosso banco de dados no Atlas.

Abra o arquivo **`core/settings.py`** e substitua completamente a vari√°vel **`DATABASES`**.

```python
# core/settings.py

DATABASES = {
    'default': {
        'ENGINE': 'djongo',
        'NAME': 'nome_do_seu_banco',  # <-- Escolha um nome para o banco, ex: 'db_loja_django'
        'ENFORCE_SCHEMA': False,      # <-- Permite a flexibilidade do NoSQL
        'CLIENT': {
            'host': 'SUA_STRING_DE_CONEXAO_AQUI'  # <-- String de Conex√£o com o MongoDB Atlas
        }
    }
}
```

üìú **Agora, vamos montar a configura√ß√£o final:**

1.  **`ENGINE`**: Deve ser `'djongo'`.

2.  **`NAME`**: Escolha um nome l√≥gico para o banco de dados que ser√° criado dentro do seu cluster no Atlas. Por exemplo, `db_loja_django`.

3.  **`host`**: Cole a string de conex√£o que voc√™ copiou do Atlas.
      * **Importante:** Substitua `<username>` pelo nome de usu√°rio que voc√™ criou (ex: `django_user`).
      
      * **Importante:** Substitua `<password>` pela senha que voc√™ definiu para esse usu√°rio.
      
      * **Opcional:** Adicione o nome do banco de dados (`NAME`) na string de conex√£o ap√≥s o `.net/`. Isso garante que o Django se conecte diretamente ao banco correto.

**Exemplo de como ficar√° sua configura√ß√£o final:**

```python
# core/settings.py

DATABASES = {
    'default': {
        'ENGINE': 'djongo',         # <-- Driver para acesso
        'NAME': 'db_loja_django',   # <-- Escolha um nome para o banco
        'ENFORCE_SCHEMA': False,    # <-- Permite a flexibilidade do NoSQL
        'CLIENT': {
            'host': 'mongodb+srv://django_user:SuaSenhaSuperSecreta@cluster0.xxxxx.mongodb.net/db_loja_django?retryWrites=true&w=majority' # <-- String de Conex√£o com o MongoDB Atlas
        }
    }
}
```

#### Passo 5: üöÄ Rodando as Migra√ß√µes

Mesmo usando um banco NoSQL "sem esquema", o Django ainda precisa de migra√ß√µes para criar as "**cole√ß√µes**" (o equivalente √†s tabelas) e gerenciar sua estrutura interna.

Execute os comandos que voc√™ j√° conhece:

```bash
python manage.py makemigrations
python manage.py migrate
```

O `djongo` vai interceptar esses comandos e, em vez de criar tabelas SQL, ele criar√° as cole√ß√µes correspondentes no seu banco de dados `db_loja_django` l√° no MongoDB Atlas.

Para verificar, voc√™ pode voltar ao site do Atlas, clicar em "**Browse Collections**" no seu cluster e ver√° as cole√ß√µes criadas pelo Django (como `produtos_produto`, `auth_user`, etc.).

### üéâ Pronto\!

Seu projeto Django agora est√° totalmente conectado a um banco de dados MongoDB na nuvem.

üöÄ **Pontos importantes a lembrar:**

  * **Flexibilidade:** Com **`ENFORCE_SCHEMA: False`**, voc√™ pode ter documentos (registros) com campos diferentes dentro da mesma cole√ß√£o. Um produto pode ter o campo `cor` e outro n√£o, sem que isso gere um erro.
  
  * **ORM:** Voc√™ continuar√° usando o ORM do Django da mesma forma (`Product.objects.create(...)`, `Product.objects.filter(...)`). O `djongo` cuida da tradu√ß√£o para as consultas do MongoDB.
  
  * **Produ√ß√£o:** A configura√ß√£o para produ√ß√£o √© a mesma, mas lembre-se de proteger suas credenciais (a string de conex√£o) **usando vari√°veis de ambiente**, em vez de deix√°-las diretamente no `settings.py`.

Agora voc√™ tem o poder e a flexibilidade do MongoDB Atlas √† sua disposi√ß√£o, combinado com a produtividade do framework Django.

