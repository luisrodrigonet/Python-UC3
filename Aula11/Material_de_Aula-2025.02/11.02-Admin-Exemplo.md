# 11.01 - Aplica√ß√£o Admin do Django

> Continua√ß√£o ...

## :nine: Exemplo Pr√°tico Completo: Sistema de Biblioteca

Vamos consolidar todo o conhecimento em um exemplo pr√°tico completo de um sistema de biblioteca:

### üíæ `models.py`:

```python
from django.db import models
from django.utils import timezone

class Autor(models.Model):
    nome = models.CharField(max_length=100, verbose_name="Nome")
    biografia = models.TextField(blank=True, verbose_name="Biografia")
    data_nascimento = models.DateField(null=True, blank=True, 
                                       verbose_name="Data de Nascimento")
    
    class Meta:
        verbose_name = "Autor"
        verbose_name_plural = "Autores"
        ordering = ['nome']
    
    def __str__(self):
        return self.nome

class Categoria(models.Model):
    nome = models.CharField(max_length=50, unique=True, verbose_name="Nome")
    descricao = models.TextField(blank=True, verbose_name="Descri√ß√£o")
    
    class Meta:
        verbose_name = "Categoria"
        verbose_name_plural = "Categorias"
        ordering = ['nome']
    
    def __str__(self):
        return self.nome

class Livro(models.Model):
    STATUS_CHOICES = [
        ('disponivel', 'Dispon√≠vel'),
        ('emprestado', 'Emprestado'),
        ('manutencao', 'Em Manuten√ß√£o'),
        ('reservado', 'Reservado'),
    ]
    
    titulo = models.CharField(max_length=200, verbose_name="T√≠tulo")
    subtitulo = models.CharField(max_length=200, blank=True, verbose_name="Subt√≠tulo")
    autores = models.ManyToManyField(Autor, related_name='livros', 
                                     verbose_name="Autores")
    categoria = models.ForeignKey(Categoria, on_delete=models.PROTECT, 
                                  related_name='livros', verbose_name="Categoria")
    isbn = models.CharField(max_length=13, unique=True, verbose_name="ISBN")
    data_publicacao = models.DateField(verbose_name="Data de Publica√ß√£o")
    numero_paginas = models.PositiveIntegerField(verbose_name="N√∫mero de P√°ginas")
    editora = models.CharField(max_length=100, verbose_name="Editora")
    preco = models.DecimalField(max_digits=7, decimal_places=2, verbose_name="Pre√ßo")
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, 
                             default='disponivel', verbose_name="Status")
    capa = models.ImageField(upload_to='capas/', null=True, blank=True, 
                            verbose_name="Capa")
    sinopse = models.TextField(blank=True, verbose_name="Sinopse")
    
    data_cadastro = models.DateTimeField(auto_now_add=True, 
                                        verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(auto_now=True, 
                                           verbose_name="√öltima Atualiza√ß√£o")
    
    class Meta:
        verbose_name = "Livro"
        verbose_name_plural = "Livros"
        ordering = ['-data_cadastro']
    
    def __str__(self):
        return f"{self.titulo} - {self.get_autores_display()}"
    
    def get_autores_display(self):
        return ", ".join([autor.nome for autor in self.autores.all()])
    
    def disponivel_para_emprestimo(self):
        return self.status == 'disponivel'

class Emprestimo(models.Model):
    livro = models.ForeignKey(Livro, on_delete=models.CASCADE, 
                             related_name='emprestimos', verbose_name="Livro")
    usuario = models.CharField(max_length=100, verbose_name="Usu√°rio")
    data_emprestimo = models.DateField(default=timezone.now, 
                                       verbose_name="Data de Empr√©stimo")
    data_devolucao_prevista = models.DateField(verbose_name="Devolu√ß√£o Prevista")
    data_devolucao_real = models.DateField(null=True, blank=True, 
                                          verbose_name="Devolu√ß√£o Real")
    observacoes = models.TextField(blank=True, verbose_name="Observa√ß√µes")
    
    class Meta:
        verbose_name = "Empr√©stimo"
        verbose_name_plural = "Empr√©stimos"
        ordering = ['-data_emprestimo']
    
    def __str__(self):
        return f"{self.livro.titulo} - {self.usuario}"
    
    def em_atraso(self):
        if self.data_devolucao_real:
            return False
        return timezone.now().date() > self.data_devolucao_prevista
```

### üë§ `admin.py`:

```python
from django.contrib import admin
from django.utils.html import format_html
from django.utils import timezone
from .models import Autor, Categoria, Livro, Emprestimo

@admin.register(Autor)
class AutorAdmin(admin.ModelAdmin):
    list_display = ('nome', 'data_nascimento', 'get_total_livros')
    search_fields = ('nome', 'biografia')
    list_filter = ('data_nascimento',)
    date_hierarchy = 'data_nascimento'
    
    fieldsets = (
        ('Informa√ß√µes Pessoais', {
            'fields': ('nome', 'data_nascimento')
        }),
        ('Biografia', {
            'fields': ('biografia',),
            'classes': ('collapse',)
        }),
    )
    
    @admin.display(description='Total de Livros')
    def get_total_livros(self, obj):
        total = obj.livros.count()
        return format_html('<strong>{}</strong>', total)

@admin.register(Categoria)
class CategoriaAdmin(admin.ModelAdmin):
    list_display = ('nome', 'get_total_livros')
    search_fields = ('nome', 'descricao')
    
    @admin.display(description='Total de Livros')
    def get_total_livros(self, obj):
        return obj.livros.count()

class EmprestimoInline(admin.TabularInline):
    model = Emprestimo
    extra = 0
    fields = ('usuario', 'data_emprestimo', 'data_devolucao_prevista', 
              'data_devolucao_real', 'get_status')
    readonly_fields = ('get_status',)
    can_delete = False
    
    @admin.display(description='Status')
    def get_status(self, obj):
        if obj.data_devolucao_real:
            return format_html('<span style="color: green;">‚úì Devolvido</span>')
        elif obj.em_atraso():
            return format_html('<span style="color: red;">‚ö† Em Atraso</span>')
        return format_html('<span style="color: blue;">üìñ Em Posse</span>')

@admin.register(Livro)
class LivroAdmin(admin.ModelAdmin):
    list_display = ('titulo', 'get_autores', 'categoria', 'get_status_badge', 
                   'preco', 'data_publicacao')
    list_filter = ('status', 'categoria', 'data_publicacao', 'autores')
    search_fields = ('titulo', 'subtitulo', 'isbn', 'autores__nome')
    filter_horizontal = ('autores',)
    date_hierarchy = 'data_cadastro'
    list_per_page = 25
    readonly_fields = ('data_cadastro', 'data_atualizacao', 
                      'get_tempo_cadastrado', 'get_capa_preview')
    
    fieldsets = (
        ('Informa√ß√µes B√°sicas', {
            'fields': ('titulo', 'subtitulo', 'autores', 'categoria')
        }),
        ('Detalhes de Publica√ß√£o', {
            'fields': ('isbn', 'editora', 'data_publicacao', 'numero_paginas'),
            'classes': ('collapse',)
        }),
        ('Conte√∫do', {
            'fields': ('sinopse', 'capa', 'get_capa_preview')
        }),
        ('Informa√ß√µes Comerciais', {
            'fields': (('preco', 'status'),)
        }),
        ('Informa√ß√µes do Sistema', {
            'fields': ('data_cadastro', 'data_atualizacao', 'get_tempo_cadastrado'),
            'classes': ('collapse',)
        }),
    )
    
    inlines = [EmprestimoInline]
    actions = ['marcar_disponivel', 'marcar_emprestado', 'aplicar_desconto_10']
    
    @admin.display(description='Autores', ordering='autores__nome')
    def get_autores(self, obj):
        return obj.get_autores_display()
    
    @admin.display(description='Status')
    def get_status_badge(self, obj):
        cores = {
            'disponivel': 'green',
            'emprestado': 'orange',
            'manutencao': 'red',
            'reservado': 'blue',
        }
        cor = cores.get(obj.status, 'gray')
        return format_html(
            '<span style="background-color: {}; color: white; '
            'padding: 3px 10px; border-radius: 3px;">{}</span>',
            cor, obj.get_status_display()
        )
    
    @admin.display(description='Tempo Cadastrado')
    def get_tempo_cadastrado(self, obj):
        delta = timezone.now() - obj.data_cadastro
        dias = delta.days
        if dias < 30:
            return f"{dias} dia(s)"
        elif dias < 365:
            return f"{dias // 30} m√™s(es)"
        else:
            return f"{dias // 365} ano(s)"
    
    @admin.display(description='Preview da Capa')
    def get_capa_preview(self, obj):
        if obj.capa:
            return format_html(
                '<img src="{}" style="max-width: 200px; max-height: 300px;" />',
                obj.capa.url
            )
        return "Sem capa"
    
    @admin.action(description='Marcar como Dispon√≠vel')
    def marcar_disponivel(self, request, queryset):
        count = queryset.update(status='disponivel')
        self.message_user(
            request, 
            f'{count} livro(s) marcado(s) como dispon√≠vel.',
            level='success'
        )
    
    @admin.action(description='Marcar como Emprestado')
    def marcar_emprestado(self, request, queryset):
        count = queryset.update(status='emprestado')
        self.message_user(request, f'{count} livro(s) marcado(s) como emprestado.')
    
    @admin.action(description='Aplicar 10% de desconto')
    def aplicar_desconto_10(self, request, queryset):
        for livro in queryset:
            livro.preco = livro.preco * 0.9
            livro.save()
        self.message_user(
            request, 
            f'Desconto de 10% aplicado em {queryset.count()} livro(s).'
        )

@admin.register(Emprestimo)
class EmprestimoAdmin(admin.ModelAdmin):
    list_display = ('livro', 'usuario', 'data_emprestimo', 
                   'data_devolucao_prevista', 'get_status_emprestimo')
    list_filter = ('data_emprestimo', 'data_devolucao_real')
    search_fields = ('livro__titulo', 'usuario')
    date_hierarchy = 'data_emprestimo'
    readonly_fields = ('get_dias_emprestimo', 'get_status_emprestimo')
    
    fieldsets = (
        ('Informa√ß√µes do Empr√©stimo', {
            'fields': ('livro', 'usuario')
        }),
        ('Datas', {
            'fields': (('data_emprestimo', 'data_devolucao_prevista'), 
                      'data_devolucao_real', 'get_dias_emprestimo')
        }),
        ('Detalhes', {
            'fields': ('observacoes', 'get_status_emprestimo'),
            'classes': ('collapse',)
        }),
    )
    
    actions = ['registrar_devolucao']
    
    @admin.display(description='Status')
    def get_status_emprestimo(self, obj):
        if obj.data_devolucao_real:
            return format_html('<span style="color: green;">‚úì Devolvido</span>')
        elif obj.em_atraso():
            dias_atraso = (timezone.now().date() - obj.data_devolucao_prevista).days
            return format_html(
                '<span style="color: red;">‚ö† {} dia(s) de atraso</span>', 
                dias_atraso
            )
        return format_html('<span style="color: blue;">üìñ Em andamento</span>')
    
    @admin.display(description='Dias de Empr√©stimo')
    def get_dias_emprestimo(self, obj):
        if obj.data_devolucao_real:
            delta = obj.data_devolucao_real - obj.data_emprestimo
        else:
            delta = timezone.now().date() - obj.data_emprestimo
        return f"{delta.days} dia(s)"
    
    @admin.action(description='Registrar devolu√ß√£o (hoje)')
    def registrar_devolucao(self, request, queryset):
        queryset = queryset.filter(data_devolucao_real__isnull=True)
        count = queryset.update(data_devolucao_real=timezone.now().date())
        
        # Atualizar status dos livros
        for emprestimo in queryset:
            emprestimo.livro.status = 'disponivel'
            emprestimo.livro.save()
        
        self.message_user(
            request, 
            f'{count} empr√©stimo(s) marcado(s) como devolvido(s).'
        )
    
    def save_model(self, request, obj, form, change):
        # Ao criar um empr√©stimo, marcar o livro como emprestado
        if not change:
            obj.livro.status = 'emprestado'
            obj.livro.save()
        super().save_model(request, obj, form, change)

# Personalizando o site admin
admin.site.site_header = "Sistema de Biblioteca - Administra√ß√£o"
admin.site.site_title = "Biblioteca Admin"
admin.site.index_title = "Bem-vindo ao Painel de Administra√ß√£o"
```


üö® Este exemplo demonstra:

1. **M√∫ltiplos modelos** com diferentes n√≠veis de complexidade
2. **Relacionamentos** (ForeignKey e ManyToMany) com inlines
3. **Campos personalizados** no list_display com formata√ß√£o HTML
4. **Filtros e busca** configurados adequadamente
5. **Fieldsets** organizados logicamente
6. **Campos readonly** com m√©todos calculados
7. **Admin actions** personalizadas
8. **Permiss√µes e valida√ß√µes** impl√≠citas
9. **Date hierarchy** para navega√ß√£o temporal
10. **Formata√ß√£o visual** com HTML e cores

## :zero: Conclus√£o

O Django Admin √© uma ferramenta extremamente poderosa que pode economizar centenas de horas de desenvolvimento. Com o conhecimento apresentado nesta aula, voc√™ est√° apto a:

- Configurar e personalizar completamente a interface administrativa
- Registrar modelos de diversas formas
- Utilizar todos os comandos de gerenciamento do Django
- Criar interfaces administrativas profissionais e intuitivas
- Implementar funcionalidades avan√ßadas como inlines, actions e permiss√µes personalizadas

üì¢ Lembre-se de que o Django Admin foi projetado para administradores do site, n√£o para usu√°rios finais. Para interfaces voltadas ao p√∫blico, voc√™ deve criar views e templates personalizados. No entanto, para pain√©is administrativos internos, o Django Admin oferece uma solu√ß√£o robusta, segura e altamente personaliz√°vel que atende √† maioria das necessidades empresariais.[3]

A documenta√ß√£o oficial do Django √© um recurso valioso para explorar funcionalidades ainda mais avan√ßadas, e a comunidade Django oferece diversos pacotes de terceiros que estendem as capacidades do admin, como terceiros que estendem as capacidades do admin, como `django-import-export`, `django-admin-interface`, e muitos outros.